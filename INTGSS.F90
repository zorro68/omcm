! --------------------------------------------------------
! --------- SUBPROGRAMA  PARA  CALCULAR TODAS LAS INTEGRALES
! --------- MOLECULARES CON GAUSSIANAS
! --------------------------------------------------------
	SUBROUTINE INTGSS(FICHERO,MAT,NUMINT)
	USE ESTRUCT
	USE GLOBAL
	
	CHARACTER*(*) FICHERO
	!REAL*16,ALLOCATABLE:: A(:),B(:)
	PARAMETER (MDIM = 3)
	REAL*16 GAMA,FACT1
    INTEGER*4 I,J,K,L
	INTEGER*4 ERROR
	!INTEGER*4 LL,LNUM
	CHARACTER*ILONG LEERVALOR

	!CERO=1.Q-15  
	!VALINF=1.Q15
	DELTA=1.Q-6 
	!PI=4.Q0*QATAN(1.Q0)

	IDIOMA=LEERVALOR('idioma.lng','Idioma','Idioma')
	
	CALL DEFINE_FICH(FICH.DAT,DIR.DAT,TRIM(FICHERO),'DAT')
	CALL LEEDAT() !LECTURA DEL FICHEO DE DATOS
	CALL DEFINE_FICH(FICH.INT,DIR.INT,FICH.INT,'INT')
	CALL DEFINE_FICH(FICH.SCR,DIR.SCR,TRIM(FICHERO),'SCR')
	CALL DEFINE_FICH(FICH.AUX,DIR.AUX,TRIM(FICHERO),'AUX')
	CALL DEFINE_FICH(FICH.GSA,DIR.GSA,'BASES','DAT')
		
	!DO I=1,N
	!	FB(I).NG=FB(I).NSFB !NGAUSS
	!ENDDO	
    
    NGAUSS=FB(1).NSFB  ! ESTAMOS SUPONIENDO QUE TODAS LAS FUNCIONES TIENEN EL MISMO NUMERO DE SUBFUNCIONES   !!!!!!ESTO HABRÁ QUE CAMBIARLO!!!!!!!!
	
	ALLOCATE (GAUSS(1:N,0:NGAUSS),STAT=ERROR) !DEFINIMOS LOS DATOS DEL DESARROLLO GAUSSIANO PARA CADA FB
	IF (ERROR.NE.0) STOP 'NO HAY MEMORIA SUFICIENTE'
	ALLOCATE (GAUSS2(1:N,0:NGAUSS),STAT=ERROR) !DEFINIMOS LOS DATOS DEL DESARROLLO GAUSSIANO PARA CADA FB
	IF (ERROR.NE.0) STOP 'NO HAY MEMORIA SUFICIENTE'
	DO I=1,N
		DO J=0,NGAUSS
			CALL INIGAUSS(GAUSS(I,J))
			CALL INIGAUSS(GAUSS2(I,J))
		ENDDO
	ENDDO
	!ALLOCATE(A(1:NGAUSS),STAT=ERROR)
	!IF (ERROR.NE.0) STOP 'NO HAY MEMORIA SUFICIENTE'
	!FORALL(I=1:NGAUSS)A(I)=0.Q0
	!ALLOCATE(B(1:NGAUSS),STAT=ERROR)
	!IF (ERROR.NE.0) STOP 'NO HAY MEMORIA SUFICIENTE'
	!FORALL(I=1:NGAUSS)B(I)=0.Q0

! --- CALCULO DEL DESARROLLO GAUSSIANO Y  LAS CONSTANTES DE NORMALIZACIÓN DE CADA GAUSSIANA(RADIAL)
	DO I=1,N
		!LL=LNUM(FB(I).NTF)
		!CALL STONG(INT(FB(I).N+1.Q0),LL,FB(I).NG,A,B)
		DO J=1,FB(I).NSFB !NG
            GAUSS(I,J).GEXP=FB(I).SFB(J).PARAMETRO3   !A(J)*FB(I).ALFA**2.Q0+FB(I).BETA
            GAUSS(I,J).GCOEF=FB(I).SFB(J).COEFICIENTE  !B(J)*(FB(I).ALFA**(1-FB(I).N+LL))
            CALL LN(FB(I).NTF, GAUSS(I,J).GNX, GAUSS(I,J).GNY, GAUSS(I,J).GNZ)
            GAMA=GAUSS(I,J).GEXP+GAUSS(I,J).GEXP
			GAUSS(I,J).GNOR=1.Q0/QSQRT((GAMA**(-GAUSS(I,J).GNX-GAUSS(I,J).GNY-GAUSS(I,J).GNZ-1.5Q0))*(FACT1(GAUSS(I,J).GNX-1)*FACT1(GAUSS(I,J).GNY-1)*FACT1(GAUSS(I,J).GNZ-1)/(2.Q0**(GAUSS(I,J).GNX+GAUSS(I,J).GNY+GAUSS(I,J).GNZ)))*(PI**1.5Q0))
            
            FB(I).SFB(J).SCNOR=1.0Q0
            IF (NORMSFB==0)THEN !NORMALIZA LAS SUBFUNCIONES
                FB(I).SFB(J).SCNOR=GAUSS(I,J).GNOR
            ENDIF
		ENDDO
	END DO

	IF(UNASOLA==1)THEN
		CALL CALCULA_UNA_GSS
	ELSE
		CALL CALCULA_TODAS_GSS(MAT,NUMINT)
        NUMINT=NINTBI
	ENDIF

	!APROBECHAMOS EL FICHERO DIR.GSA PARA ESCRIBIR LOS EXPONENTES Y COEF DE LAS GAUSSIANAS
	!OPEN(UNIT=15,FILE=TRIM(DIR.GSA))
	!DO I=1,N
	!	WRITE(15,*)FB(I).NG
	!	DO J=1,FB(I).NG
	!		WRITE(15,*)GAUSS(I,J).GCOEF,GAUSS(I,J).GEXP
	!	ENDDO
	!ENDDO
	!CLOSE(15)
	

	RETURN
    END 

! ------------------------------------------------------
!--------CALCULO DE UNA SOLA INTEGRAL-------------------
! ------------------------------------------------------
	SUBROUTINE CALCULA_UNA_GSS
	USE ESTRUCT
	USE GLOBAL
	CHARACTER*ILONG INTTOSTR,REALTOSTR,CADIDIOMA,LEERVALOR,CAD

	CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1210')
	CAD=' '
	CALL MENSAJES(CADIDIOMA,CAD,1.Q0)
	
	IF(SN1/=0)THEN
		CALL CALCULA_GSS('S',SN1,SN1,0,0,INTEGRAL)
		FB(SN1).ANOR=1.Q0/QSQRT(INTEGRAL)
	ENDIF
	IF (SN2/=0.AND.SN2/=SN1)THEN
		CALL CALCULA_GSS('S',SN2,SN2,0,0,INTEGRAL)
		FB(SN2).ANOR=1.Q0/QSQRT(INTEGRAL)
	ENDIF
	IF (SN3/=0.AND.(SN3/=SN2.AND.SN3/=SN1))THEN
		CALL CALCULA_GSS('S',SN3,SN3,0,0,INTEGRAL)
		FB(SN3).ANOR=1.Q0/QSQRT(INTEGRAL)
	ENDIF
	IF (SN4/=0.AND.(SN4/=SN3.AND.SN4/=SN2.AND.SN4/=SN1))THEN
		CALL CALCULA_GSS('S',SN4,SN4,0,0,INTEGRAL)
		FB(SN4).ANOR=1.Q0/QSQRT(INTEGRAL)
	ENDIF
	
	CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1211')
	IF(CLASINT=='J'.OR.CLASINT=='j')THEN
		WRITE(CAD,'(A1,2I2,A2,2I2,A1)')'(',SN1,SN2,' |',SN3,SN4,')'
		CALL CALCULA_GSS(CLASINT,SN1,SN2,SN3,SN4,INTEGRAL)
		INTEGRAL=INTEGRAL*FB(SN1).ANOR*FB(SN2).ANOR*FB(SN3).ANOR*FB(SN4).ANOR
	ELSEIF(CLASINT=='S'.OR.CLASINT=='s')THEN
		WRITE(CAD,'(A1,I2,A2,I2,A1)')'<',SN1,' |',SN2,'>'
		CALL CALCULA_GSS(CLASINT,SN1,SN2,SN3,SN4,INTEGRAL)
		INTEGRAL=INTEGRAL*FB(SN1).ANOR*FB(SN2).ANOR
	ELSE
		WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1)')'<',SN1,' |',CLASINT,'|',SN2,'>'
		CALL CALCULA_GSS(CLASINT,SN1,SN2,SN3,SN4,INTEGRAL)
		INTEGRAL=INTEGRAL*FB(SN1).ANOR*FB(SN2).ANOR
	ENDIF	
	CALL MENSAJES(CADIDIOMA,CAD,50.Q0)

	CALL ESCINT(0,0)

	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','TipoInt',TRIM(CLASINT))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Indice1',INTTOSTR(SN1))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Indice2',INTTOSTR(SN2))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Indice3',INTTOSTR(SN3))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Indice4',INTTOSTR(SN4))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Integral',REALTOSTR(INTEGRAL))
	CALL GUARDAVALOR(DIR.INT,'INTEGRALES','Error',REALTOSTR(ERINTS))

	END 

! ------------------------------------------------------
!--------CALCULO DE UNA SOLA INTEGRAL GAUSSIANA --------
! ------------------------------------------------------
	SUBROUTINE CALCULA_GSS(TIPO,N1,N2,N3,N4,VALINT)
	USE ESTRUCT
	USE GLOBAL
	PARAMETER (NAS=19)
	CHARACTER*1 TIPO
	INTEGER*4 N1,N2,N3,N4
	INTEGER*4 NX,NY,NZ,I,J,K,L
	REAL*16 SR1(0:NAS),SR2(0:NAS),SR3(0:NAS),SR4(0:NAS),INTEG,VALINT


	IF (TIPO=='J'.OR.TIPO=='j') THEN
		CALL SOL_REAL(FB(N1).NTF,SR1)
		CALL SOL_REAL(FB(N2).NTF,SR2)
		CALL SOL_REAL(FB(N3).NTF,SR3)
		CALL SOL_REAL(FB(N4).NTF,SR4)
		
		VALINT=0.Q0
		DO I=0,NAS
			IF(SR1(I).NE.0)THEN
				CALL LN(I,NX,NY,NZ)
				DO K=1,FB(N1).NSFB
					GAUSS(N1,K).GNX=NX
					GAUSS(N1,K).GNY=NY
					GAUSS(N1,K).GNZ=NZ
				ENDDO	
				DO J=0,NAS
					IF(SR2(J).NE.0)THEN
						CALL LN(J,NX,NY,NZ)
						IF (N1.NE.N2)THEN
							DO L=1,FB(N2).NSFB
								GAUSS(N2,L).GNX=NX
								GAUSS(N2,L).GNY=NY
								GAUSS(N2,L).GNZ=NZ
							ENDDO
						ELSE
							GAUSS(N2,0).GNX=NX
							GAUSS(N2,0).GNY=NY
							GAUSS(N2,0).GNZ=NZ
						ENDIF
							DO K=0,NAS
							IF(SR3(K).NE.0)THEN
								CALL LN(K,NX,NY,NZ)
								DO M=1,FB(N3).NSFB
									GAUSS2(N3,M).GNX=NX
									GAUSS2(N3,M).GNY=NY
									GAUSS2(N3,M).GNZ=NZ
								ENDDO	
								DO L=0,NAS
									IF(SR4(L).NE.0)THEN
										CALL LN(L,NX,NY,NZ)
										IF (N3.NE.N4)THEN
											DO M=1,FB(N4).NSFB
												GAUSS2(N4,M).GNX=NX
												GAUSS2(N4,M).GNY=NY
												GAUSS2(N4,M).GNZ=NZ
											ENDDO
										ELSE
											GAUSS2(N4,0).GNX=NX
											GAUSS2(N4,0).GNY=NY
											GAUSS2(N4,0).GNZ=NZ
										ENDIF
										CALL SOLOUNA_BI_GSS(N1,N2,N3,N4,INTEG)
									ENDIF
									VALINT=VALINT+INTEG*SR1(I)*SR2(J)*SR3(K)*SR4(L)
								ENDDO
							ENDIF
						ENDDO
					ENDIF
				ENDDO
			ENDIF
		ENDDO
	ELSE
		CALL SOL_REAL(FB(N1).NTF,SR1)
		CALL SOL_REAL(FB(N2).NTF,SR2)
		
		VALINT=0.Q0
		DO I=0,NAS
			IF(SR1(I).NE.0)THEN
				CALL LN(I,NX,NY,NZ)
				DO K=1,FB(N1).NSFB
					GAUSS(N1,K).GNX=NX
					GAUSS(N1,K).GNY=NY
					GAUSS(N1,K).GNZ=NZ
				ENDDO	
				DO J=0,NAS
					IF(SR2(J).NE.0)THEN
						CALL LN(J,NX,NY,NZ)
						IF (N1.NE.N2)THEN
							DO L=1,FB(N2).NSFB
								GAUSS(N2,L).GNX=NX
								GAUSS(N2,L).GNY=NY
								GAUSS(N2,L).GNZ=NZ
							ENDDO
						ELSE
							GAUSS(N2,0).GNX=NX
							GAUSS(N2,0).GNY=NY
							GAUSS(N2,0).GNZ=NZ
						ENDIF
						CALL MONO_SOLOUNA_GSS(TIPO,N1,N2,INTEG)
					ENDIF
					VALINT=VALINT+INTEG*SR1(I)*SR2(J)
				ENDDO
			ENDIF
		ENDDO
	ENDIF

	END
! ---------------------------------------------------------------------
! --- SUBRUTINA QUE CALCULA LAS INTEGRALES
! ---------------------------------------------------------------------
	SUBROUTINE CALCULA_TODAS_GSS(MAT,NUMINT)
	USE ESTRUCT
	USE GLOBAL
	INTEGER*4 MAT,NUMINT
	REAL*16 INTEG
	CHARACTER*ILONG CADIDIOMA,LEERVALOR,CAD

	IF(MAT==0)THEN
		CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1210')		
		CAD=' '
		CALL MENSAJES(CADIDIOMA,CAD,1.Q0)
		
		DO I=1,N
			CALL CALCULA_GSS('S',I,I,0,0,INTEG)
			FB(I).ANOR=1.Q0/QSQRT(INTEG)	
		ENDDO

		CALL INTGSS_MONO(MAT)
	ELSEIF (MAT>0) THEN
		CALL LEEINT(MAT,NUMINT)
		CALL INTGSS_MONO(MAT)
    END IF

    IF(NEL>1.AND.MAT<=4)THEN
		CALL INTGSS_BI(MAT,NUMINT)
	ENDIF

	END

!*******************************************************************
! --------- SUBPROGRAMA  PARA  CALCULAR   S(p,q) Y H(p,q) 
! --------- X(p,q),Y,Z y V(p,q,centro pot)
! --------- G A U S S I A N A S
!*******************************************************************
	SUBROUTINE INTGSS_MONO(MAT)
	USE ESTRUCT
	USE GLOBAL
	IMPLICIT REAL*16(A-H,O-Z)
	REAL*16 INTEG
	CHARACTER*ILONG LEERVALOR,CADIDIOMA,CAD
	INTEGER*4 MAT
	
    TIEN=0.Q0
	TMONO=DBLE(7.Q0*N*(N+1)) !SON 7 TIPOS DE INTEGRALES MONO: S,T,V,H,X,Y,Z
	TBIEL=0.Q0
	IF (NEL>1)TBIEL=2.7Q0*DBLE(N_INT_BI) !CADA INTEGRAL BI TIENE UN PESO DE 2.7 VECES 2 MONO
	TTOTAL=TMONO+TBIEL

	CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1212')	
	
	IF(MAT<1)THEN
		CALL ESCINT(0,0)
	ENDIF
	
	IF(MAT<2)THEN
		DO I=1,N
			DO J=I,N
				NB1=I
				NB2=J
				INDICE=INPQ_F(I,J)
				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,I2,A1,A,F5.1,A)')'<',I,' |',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)	
				CALL CALCULA_GSS('S',NB1,NB2,0,0,INTEG)
				S(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR
			ENDDO
		ENDDO
		!MAT=1
		CALL ESCINT(1,0)
	ENDIF

	IF(MAT<3)THEN
		DO I=1,N
			DO J=I,N
				NB1=I
				NB2=J
				INDICE=INPQ_F(I,J)
				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','T','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				CALL CALCULA_GSS('T',NB1,NB2,0,0,INTEG)
				T(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR

				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','V','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				CALL CALCULA_GSS('V',NB1,NB2,0,0,INTEG)
				V(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR

				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','H','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				H(INDICE)=T(INDICE)+V(INDICE)
			ENDDO
		ENDDO
		!MAT=2
		CALL ESCINT(2,0)
	ENDIF
	
	IF(MAT<4)THEN
		DO I=1,N
			DO J=I,N
				NB1=I
				NB2=J
				INDICE=INPQ_F(I,J)
				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','X','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				CALL CALCULA_GSS('X',NB1,NB2,0,0,INTEG)
				XMAT(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR

				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','Y','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				CALL CALCULA_GSS('Y',NB1,NB2,0,0,INTEG)
				YMAT(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR

				TIEN=TIEN+2.0Q0
				PCTO=1.0Q2*TIEN/TTOTAL
				WRITE(CAD,'(A1,I2,A2,A,A1,I2,A1,A,F5.1,A)')'<',I,' |','Z','|',J,'>',' (',PCTO,'%)'
				CALL MENSAJES(CADIDIOMA,CAD,PCTO)
				CALL CALCULA_GSS('Z',NB1,NB2,0,0,INTEG)
				ZMAT(INDICE)=INTEG*FB(NB1).ANOR*FB(NB2).ANOR
				IF(QABS(POT(1))>CERO)H(INDICE)=H(INDICE)-POT(1)*XMAT(INDICE)
				IF(QABS(POT(2))>CERO)H(INDICE)=H(INDICE)-POT(2)*YMAT(INDICE)
				IF(QABS(POT(3))>CERO)H(INDICE)=H(INDICE)-POT(3)*ZMAT(INDICE)
			END DO
		END DO
		MAT=3
		CALL ESCINT(MAT,0)
	ENDIF

	RETURN 
	END

! ***************************************************************
!    SUBROUTINA QUE CALCULA UNA INTEGRAL MONOELECTONICA CON GAUSSIANAS
! ***************************************************************
	RECURSIVE SUBROUTINE MONO_SOLOUNA_GSS(TIPO,N1,N2,INTEG)
	USE ESTRUCT
	USE GLOBAL
	CHARACTER*1 TIPO
	INTEGER*4 N1,N2
	REAL*16 SG,TG,VG,MG,HG,INTEG,ANOR
	INTEGER*4 I,J,K

	!CLASINT=TIPO

	INTEG=0.Q0
	IF (TIPO=='S'.OR.TIPO=='s')THEN
		!IF (N1==N2)THEN
		!	INTEG=1.Q0
		!ELSE
			DO I=1,FB(N1).NSFB
				DO J=1,FB(N2).NSFB
					INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*SG(N1,N2,I,J)
				ENDDO
			ENDDO	
			!INTEG=INTEG*FB(N1).ANOR*FB(N2).ANOR
		!ENDIF
		RETURN
	ENDIF
	IF (TIPO=='T'.OR.TIPO=='t')THEN
		DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*TG(N1,N2,I,J)
			ENDDO
		ENDDO	
		!INTEG=INTEG*FB(N1).ANOR*FB(N2).ANOR
		RETURN
	ENDIF
	IF (TIPO=='X'.OR.TIPO=='x')THEN
		NN.NX=1
		NN.NY=0
		NN.NZ=0
		DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*MG(N1,N2,I,J,NN)
			ENDDO
		ENDDO	
		!INTEG=INTEG*FB(N1).ANOR*FB(N2).ANOR
		RETURN
	ENDIF
	IF (TIPO=='Y'.OR.TIPO=='y')THEN
		NN.NX=0
		NN.NY=1
		NN.NZ=0
		DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*MG(N1,N2,I,J,NN)
			ENDDO
		ENDDO	
		!INTEG=INTEG*FB(N1).ANOR*FB(N2).ANOR
		RETURN
	ENDIF
	IF (TIPO=='Z'.OR.TIPO=='z')THEN
		NN.NX=0
		NN.NY=0
		NN.NZ=1
		DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*MG(N1,N2,I,J,NN)
			ENDDO
		ENDDO	
		!INTEG=INTEG*FB(N1).ANOR*FB(N2).ANOR
		RETURN
	ENDIF
	IF (TIPO=='V'.OR.TIPO=='v')THEN
		DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				INTEG=INTEG+GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*VG(N1,N2,I,J)
			ENDDO
		ENDDO	
		INTEG=(-1.Q0)*INTEG !*FB(N1).ANOR*FB(N2).ANOR
		RETURN
	ENDIF
	IF (TIPO=='H'.OR.TIPO=='h')THEN
		CALL MONO_SOLOUNA_GSS('T',N1,N2,INTEG)
		HG=INTEG
		CALL MONO_SOLOUNA_GSS('V',N1,N2,INTEG)
		INTEG=INTEG+HG
		RETURN
	ENDIF

	END 

! ***************************************************************
!    SUBROUTINA QUE PERMITE PASAR DE INTEGRALES DE 
!	 LAS 20 FUNCIONES (X^NX*Y^NY*Z^NZ)*G(R) (ARMONICOS SÓLIDOS) 
!    A LAS 16 FUNCIONES S,P,D,F (ARMÓNICOS REALES)
!	 (OJO LLEGA HASTA LOS F)
! ***************************************************************
	SUBROUTINE SOL_REAL(L,S_R)
	!USE GLOBAL, ONLY:PI
	PARAMETER (NAE = 15)
	PARAMETER (NAS = 19) !LLEGA HASTA LOS ORBITALES F
	REAL*16 ARM(0:NAE,0:NAS)
	INTEGER*4 L
	REAL*16 S_R(0:NAS)

	DO I=0,NAE
		DO J=0,NAS
			ARM(I,J)=0.Q0
		ENDDO
	ENDDO
	!S
	ARM(0,0)=1.Q0 
	!P
	ARM(1,1)=1.Q0
	ARM(2,2)=1.Q0
	ARM(3,3)=1.Q0
	!D
	ARM(4,4)=QSQRT(3.Q0)/2.Q0
	ARM(4,5)=-QSQRT(3.Q0)/2.Q0
	ARM(5,7)=1.Q0
	ARM(6,8)=1.Q0
	ARM(7,9)=1.Q0
	ARM(8,4)=-0.5Q0
	ARM(8,5)=-0.5Q0
	ARM(8,6)=1.Q0
	!F
	ARM(9,10)=QSQRT(5.Q0/44.Q0)
	ARM(9,14)=-3.Q0*QSQRT(5.Q0/44.Q0)
	ARM(10,11)=-3.Q0*QSQRT(5.Q0/44.Q0)
	ARM(10,13)=QSQRT(5.Q0/44.Q0)
	ARM(11,12)=QSQRT(15.Q0/28.Q0)
	ARM(11,15)=-QSQRT(15.Q0/28.Q0)
	ARM(12,19)=1.Q0
	ARM(13,10)=QSQRT(15.Q0/244.Q0)
	ARM(13,14)=QSQRT(15.Q0/244.Q0)
	ARM(13,17)=-4.Q0*QSQRT(15.Q0/244.Q0)
	ARM(14,11)=QSQRT(15.Q0/244.Q0)
	ARM(14,13)=QSQRT(15.Q0/244.Q0)
	ARM(14,18)=-4.Q0*QSQRT(15.Q0/244.Q0)
	ARM(15,12)=-3.Q0*QSQRT(5.Q0/92.Q0)
	ARM(15,15)=-3.Q0*QSQRT(5.Q0/92.Q0)
	ARM(15,16)=2.Q0*QSQRT(5.Q0/92.Q0)
	
	DO I=0,NAS
		S_R(I)=ARM(L,I)
	ENDDO

	END

! ***************************************************************
!	MATRIZ QUE DADO UN L DEVUELVE LOS VALORES NX NY NZ
! ***************************************************************
	SUBROUTINE LN(F,NX,NY,NZ)
	INTEGER*4 F,NX,NY,NZ
	PARAMETER (NAS = 19)
	INTEGER*4 NS(0:NAS,1:3)

	NS(0,1)=0
	NS(0,2)=0
	NS(0,3)=0
	NS(1,1)=1
	NS(1,2)=0
	NS(1,3)=0
	NS(2,1)=0
	NS(2,2)=1
	NS(2,3)=0
	NS(3,1)=0
	NS(3,2)=0
	NS(3,3)=1
	NS(4,1)=2
	NS(4,2)=0
	NS(4,3)=0
	NS(5,1)=0
	NS(5,2)=2
	NS(5,3)=0
	NS(6,1)=0
	NS(6,2)=0
	NS(6,3)=2
	NS(7,1)=1
	NS(7,2)=1
	NS(7,3)=0
	NS(8,1)=1
	NS(8,2)=0
	NS(8,3)=1
	NS(9,1)=0
	NS(9,2)=1
	NS(9,3)=1
	NS(10,1)=3
	NS(10,2)=0
	NS(10,3)=0
	NS(11,1)=2
	NS(11,2)=1
	NS(11,3)=0
	NS(12,1)=2
	NS(12,2)=0
	NS(12,3)=1
	NS(13,1)=0
	NS(13,2)=3
	NS(13,3)=0
	NS(14,1)=1
	NS(14,2)=2
	NS(14,3)=0
	NS(15,1)=0
	NS(15,2)=2
	NS(15,3)=1
	NS(16,1)=0
	NS(16,2)=0
	NS(16,3)=3
	NS(17,1)=1
	NS(17,2)=0
	NS(17,3)=2
	NS(18,1)=0
	NS(18,2)=1
	NS(18,3)=2
	NS(19,1)=1
	NS(19,2)=1
	NS(19,3)=1

	NX=NS(F,1)
	NY=NS(F,2)
	NZ=NS(F,3)
    END

! -------------------------------------------------
! --  SUBPROGRAMA PARA LA DETERMINACION DE L (DADO EL TIPO DE PARTE ANGULAR - S=0 PX=1 PY=2.... DEVUELVE EL NUMERO CUANTICO L)
! -------------------------------------------------
	INTEGER*4 FUNCTION LNUM(NTIPO)
	INTEGER*4 NTIPO

	LNUM=0
	IF(NTIPO>=1)LNUM=1
	IF(NTIPO>=4)LNUM=2
	IF(NTIPO>=9)LNUM=3
	
	RETURN
    END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA INTEGRAL DE SOLAPAMIENTO ENTRE 
!   DOS GAUSSIANAS
!*******************************************************************
	REAL*16 FUNCTION SG(NB1,NB2,NG1,NG2)
	USE GLOBAL
	USE ESTRUCT
	INTEGER*4 NB1,NB2,NG1,NG2
	INTEGER*4 IL1,IL2,IM1,IM2,IN1,IN2
	REAL*16 GEXP1,GEXP2,INT_GPH,SX,SY,SZ !,ANOR1,ANOR2
	RECORD/XYZ/A,B
	
	IF (NB1.NE.NB2)THEN
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,NG2).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,NG2).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,NG2).GNZ
	ELSE
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,0).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,0).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,0).GNZ
	ENDIF
	GEXP1=GAUSS(NB1,NG1).GEXP
	GEXP2=GAUSS(NB2,NG2).GEXP
	A.X=FB(NB1).X
	A.Y=FB(NB1).Y
	A.Z=FB(NB1).Z
	B.X=FB(NB2).X
	B.Y=FB(NB2).Y
	B.Z=FB(NB2).Z
	!ANOR1=GAUSS(NB1,NG1).GNOR
	!ANOR2=GAUSS(NB2,NG2).GNOR

	SX=INT_GPH(IL1,IL2,0,GEXP1,GEXP2,A.X,B.X)
	SY=INT_GPH(IM1,IM2,0,GEXP1,GEXP2,A.Y,B.Y)
	SZ=INT_GPH(IN1,IN2,0,GEXP1,GEXP2,A.Z,B.Z)
	!SG=ANOR1*ANOR2*SX*SY*SZ
	SG=SX*SY*SZ

	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA INTEGRAL DEL PRODUCTO DE DOS GAUSSIANAS
!	PARA X Ó Y Ó Z (PAG 179 LEROY)
!	IL: SOLO SE UTILIZA PARA LAS INTEGRALES DE MOMENTO, PARA EL RESTO 
!		VALE CERO
!*******************************************************************
	REAL*16 FUNCTION INT_GPH(IL1,IL2,IL,GEXP1,GEXP2,AH,BH)
	USE GLOBAL !PARA EL VALOR DE PI
	INTEGER*4 IL1,IL2,IL
	REAL*16 GEXP1,GEXP2,AH,BH
	REAL*16 GAMA,ABH,PH,PAH,PBH,KH,P
	REAL*16 FKH,FKGAMMA
	INTEGER*4 K,I,J

	IF(IL1<0.OR.IL2<0)THEN
		INT_GPH=0.Q0
		RETURN
	ENDIF
	
	GAMA=GEXP1+GEXP2

	ABH=AH-BH
	KH=QEXP(-((GEXP1*GEXP2)/GAMA)*ABH**2)
	PH=(GEXP1*AH+GEXP2*BH)/GAMA
	PAH=PH-AH
	PBH=PH-BH

	P=0.Q0
	IF (IL.NE.0)P=PH	!PARA LA INTEGRAL DE MOMENTO
	INT_GPH=0.Q0

	DO K=0,(IL1+IL2+IL)/2
		INT_GPH=INT_GPH+FKH(IL1,IL2,IL,PAH,PBH,P,2*K)*FKGAMMA(GAMA,2*K)
	ENDDO
	
	INT_GPH=KH*INT_GPH

	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LAS FUNCIONES FKh (DONDE h PUEDE SER
!	X Ó Y Ó Z) (PAG 179 LEROY)
!	L: SOLO SE UTILIZA PARA LAS INTEGRALES DE MOMENTO, PARA EL RESTO 
!		VALE CERO
!*******************************************************************
	REAL*16 FUNCTION FKH(L1,L2,L,PAH,PBH,PH,K)
	INTEGER*4 L1,L2,L,K,I,II,J
	REAL*16 PAH,PBH,PH,FACT
		
	FKH=0.Q0
	DO II=0,L
		DO I=0,L1
			J=K-I-II
			IF (J<=L2.AND.J>=0)THEN
				FKH=FKH+(PAH**(L1-I))*(PBH**(L2-J))*(PH**(L-II))*(FACT(L1)/(FACT(I)*FACT(L1-I)))*(FACT(L2)/(FACT(J)*FACT(L2-J)))*(FACT(L)/(FACT(II)*FACT(L-II)))
			ENDIF
		ENDDO
	ENDDO
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LAS FUNCIONES FKGAMMA (PAG 179 LEROY)
!*******************************************************************
	REAL*16 FUNCTION FKGAMMA(GAMMA,K)
	USE GLOBAL !SÓLO PARA EL VALOR DE PI
	REAL*16 GAMMA,FACT1
	INTEGER*4 K

	IF (MOD(K,2)==0)THEN
		FKGAMMA=(FACT1(K-1)/(2.Q0**(K/2.Q0)))*(GAMMA**(-(K+1)*0.5Q0))*(PI**0.5Q0)
	ELSE
		FKGAMMA=0.Q0
	ENDIF

	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA INTEGRAL DE ENERGÍA CINÉTICA ENTRE 
!   DOS GAUSSIANAS
!*******************************************************************
	REAL*16 FUNCTION TG(NB1,NB2,NG1,NG2)
	USE GLOBAL
	USE ESTRUCT
	INTEGER*4 IL1,IL2,IM1,IM2,IN1,IN2
	INTEGER*4 NB1,NB2,NG1,NG2
	REAL*16 GEXP1,GEXP2,INT_GPH,TX,TY,TZ,SX,SY,SZ !,ANOR1,ANOR2
	RECORD/XYZ/A,B
	
	IF (NB1.NE.NB2)THEN
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,NG2).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,NG2).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,NG2).GNZ
	ELSE
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,0).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,0).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,0).GNZ
	ENDIF
	GEXP1=GAUSS(NB1,NG1).GEXP
	GEXP2=GAUSS(NB2,NG2).GEXP
	A.X=FB(NB1).X
	A.Y=FB(NB1).Y
	A.Z=FB(NB1).Z
	B.X=FB(NB2).X
	B.Y=FB(NB2).Y
	B.Z=FB(NB2).Z
	!ANOR1=GAUSS(NB1,NG1).GNOR
	!ANOR2=GAUSS(NB2,NG2).GNOR

	SX=INT_GPH(IL1,IL2,0,GEXP1,GEXP2,A.X,B.X)
	SY=INT_GPH(IM1,IM2,0,GEXP1,GEXP2,A.Y,B.Y)
	SZ=INT_GPH(IN1,IN2,0,GEXP1,GEXP2,A.Z,B.Z)

	TX=-IL1*IL2*INT_GPH(IL1-1,IL2-1,0,GEXP1,GEXP2,A.X,B.X)+ &
	    2.Q0*GEXP2*IL1*INT_GPH(IL1-1,IL2+1,0,GEXP1,GEXP2,A.X,B.X)+ &
		2.Q0*GEXP1*IL2*INT_GPH(IL1+1,IL2-1,0,GEXP1,GEXP2,A.X,B.X)- &
		4.Q0*GEXP1*GEXP2*INT_GPH(IL1+1,IL2+1,0,GEXP1,GEXP2,A.X,B.X)

	TY=-IM1*IM2*INT_GPH(IM1-1,IM2-1,0,GEXP1,GEXP2,A.Y,B.Y)+ &
	    2.Q0*GEXP2*IM1*INT_GPH(IM1-1,IM2+1,0,GEXP1,GEXP2,A.Y,B.Y)+ &
		2.Q0*GEXP1*IM2*INT_GPH(IM1+1,IM2-1,0,GEXP1,GEXP2,A.Y,B.Y)- &
		4.Q0*GEXP1*GEXP2*INT_GPH(IM1+1,IM2+1,0,GEXP1,GEXP2,A.Y,B.Y)

	TZ=-IN1*IN2*INT_GPH(IN1-1,IN2-1,0,GEXP1,GEXP2,A.Z,B.Z)+ &
	    2.Q0*GEXP2*IN1*INT_GPH(IN1-1,IN2+1,0,GEXP1,GEXP2,A.Z,B.Z)+ &
		2.Q0*GEXP1*IN2*INT_GPH(IN1+1,IN2-1,0,GEXP1,GEXP2,A.Z,B.Z)- &
		4.Q0*GEXP1*GEXP2*INT_GPH(IN1+1,IN2+1,0,GEXP1,GEXP2,A.Z,B.Z)

	!TG=-0.5Q0*ANOR1*ANOR2*(TX*SY*SZ+SX*TY*SZ+SX*SY*TZ)
	TG=-0.5Q0*(TX*SY*SZ+SX*TY*SZ+SX*SY*TZ)
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA INTEGRAL DE MOMENTO ENTRE 
!   DOS GAUSSIANAS
!*******************************************************************
	REAL*16 FUNCTION MG(NB1,NB2,NG1,NG2,MOMENTO)
	USE GLOBAL
	USE ESTRUCT
	INTEGER*4 NB1,NB2,NG1,NG2
	INTEGER*4 IL1,IL2,IL,IM1,IM2,IM,IN1,IN2,IN
	REAL*16 GEXP1,GEXP2,INT_GPH,MX,MY,MZ !,ANOR1,ANOR2
	
	TYPE(NNN)MOMENTO
	TYPE(XYZ)A,B

	IF (NB1.NE.NB2)THEN
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,NG2).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,NG2).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,NG2).GNZ
	ELSE
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,0).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,0).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,0).GNZ
	ENDIF
	GEXP1=GAUSS(NB1,NG1).GEXP
	GEXP2=GAUSS(NB2,NG2).GEXP
	A.X=FB(NB1).X
	A.Y=FB(NB1).Y
	A.Z=FB(NB1).Z
	B.X=FB(NB2).X
	B.Y=FB(NB2).Y
	B.Z=FB(NB2).Z
	!ANOR1=GAUSS(NB1,NG1).GNOR
	!ANOR2=GAUSS(NB2,NG2).GNOR
		
	MX=INT_GPH(IL1,IL2,MOMENTO.NX,GEXP1,GEXP2,A.X,B.X)
	MY=INT_GPH(IM1,IM2,MOMENTO.NY,GEXP1,GEXP2,A.Y,B.Y)
	MZ=INT_GPH(IN1,IN2,MOMENTO.NZ,GEXP1,GEXP2,A.Z,B.Z)
	!MG=ANOR1*ANOR2*MX*MY*MZ
	MG=MX*MY*MZ
	
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA INTEGRAL DE ENERGIA POTENCIAL ENTRE 
!   DOS GAUSSIANAS
!*******************************************************************
	REAL*16 FUNCTION VG(NB1,NB2,NG1,NG2)
	USE GLOBAL
	USE ESTRUCT
	INTEGER*4 NB1,NB2,NG1,NG2
	INTEGER*4 IL1,IL2,IM1,IM2,IN1,IN2,I
	REAL*16 GEXP1,GEXP2,GAMA,K,PC2,INT,INT1,FV(0:16) !,ANOR1,ANOR2
	INTEGER*4 KX,KY,KZ
	RECORD/XYZ/A,B,AB,P,PAA,PBB,PCC
	TYPE(POLINOMIO)::PX,PY,PZ,PAUX,POL,P1T,PT,PTOTAL
	
	IF (NB1.NE.NB2)THEN
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,NG2).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,NG2).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,NG2).GNZ
	ELSE
		IL1=GAUSS(NB1,NG1).GNX
		IL2=GAUSS(NB2,0).GNX
		IM1=GAUSS(NB1,NG1).GNY
		IM2=GAUSS(NB2,0).GNY
		IN1=GAUSS(NB1,NG1).GNZ
		IN2=GAUSS(NB2,0).GNZ
	ENDIF
	GEXP1=GAUSS(NB1,NG1).GEXP
	GEXP2=GAUSS(NB2,NG2).GEXP
	A.X=FB(NB1).X
	A.Y=FB(NB1).Y
	A.Z=FB(NB1).Z
	B.X=FB(NB2).X
	B.Y=FB(NB2).Y
	B.Z=FB(NB2).Z

	GAMA=GEXP1+GEXP2

	AB.X=A.X-B.X
	AB.Y=A.Y-B.Y
	AB.Z=A.Z-B.Z
	K=QEXP(-((GEXP1*GEXP2)/GAMA)*(AB.X**2+AB.Y**2+AB.Z**2))
	P.X=(GEXP1*A.X+GEXP2*B.X)/GAMA
	P.Y=(GEXP1*A.Y+GEXP2*B.Y)/GAMA
	P.Z=(GEXP1*A.Z+GEXP2*B.Z)/GAMA
	PAA.X=P.X-A.X
	PAA.Y=P.Y-A.Y
	PAA.Z=P.Z-A.Z
	PBB.X=P.X-B.X
	PBB.Y=P.Y-B.Y
	PBB.Z=P.Z-B.Z
	
	INT=0.Q0
 	DO INUC=1,NUC
		PCC.X=P.X-NUCLEOS(INUC).X
		PCC.Y=P.Y-NUCLEOS(INUC).Y
		PCC.Z=P.Z-NUCLEOS(INUC).Z
		PC2=PCC.X**2+PCC.Y**2+PCC.Z**2
		CALL FREQ16(GAMA*PC2,FV)

		P1T.GRADO=2		!POLINOMIO 1-t^2
		P1T.C(0)=1.Q0
		P1T.C(1)=0.Q0
		P1T.C(2)=-1.Q0

		DO KX=0,(IL1+IL2)/2
			DO KY=0,(IM1+IM2)/2
				DO KZ=0,(IN1+IN2)/2
					CALL FKH_POL(IL1,IL2,GEXP1,GEXP2,PAA.X,PBB.X,PCC.X,2*KX,PX)
					CALL FKH_POL(IM1,IM2,GEXP1,GEXP2,PAA.Y,PBB.Y,PCC.Y,2*KY,PY)
					CALL FKH_POL(IN1,IN2,GEXP1,GEXP2,PAA.Z,PBB.Z,PCC.Z,2*KZ,PZ)
					CALL PROPOL(PX,PY,PAUX)
					CALL PROPOL(PAUX,PZ,POL)
					
					CALL ELEVAPOL(P1T,PT,KX+KY+KZ)
					
					CALL PROPOL(POL,PT,PTOTAL)

					INT1=0.Q0
					DO I=0,PTOTAL.GRADO,2
						INT1=INT1+PTOTAL.C(I)*FV(I/2)
					ENDDO
					INT=INT+NUCLEOS(INUC).CARGA*INT1
				ENDDO
			ENDDO
		ENDDO	
	ENDDO
	
	!VG=(2.Q0*ANOR1*ANOR2*K/(GAMA*QSQRT(PI)))*INT
 	VG=(2.Q0*K/(GAMA*QSQRT(PI)))*INT
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LAS FUNCIONES FKH PERO DEVOLVIENDO UN 
!	POLINOMIO PH (DONDE H PUEDE SER X Ó Y Ó Z) (PAG 187 LEROY)
!*******************************************************************
	SUBROUTINE FKH_POL(L1,L2,GEXP1,GEXP2,PAH,PBH,PCH,K,PH)
	USE ESTRUCT
	INTEGER*4 L1,L2,K,I,J,IN
	REAL*16 PAH,PBH,PCH,GAMA,FKGAMMA,NUM,GEXP1,GEXP2,FACT
	TYPE (POLINOMIO)::PHAUX,PHAUX1,PH,P1,P2,PS1,PS2
			
	PH.GRADO=0
	DO I=0,MAXGRAD
		PH.C(I)=0.Q0
	ENDDO

	P1.GRADO=2
	P1.C(0)=PAH
	P1.C(1)=0.Q0
	P1.C(2)=-PCH
	P2.GRADO=2
	P2.C(0)=PBH
	P2.C(1)=0.Q0
	P2.C(2)=-PCH
	GAMA=GEXP1+GEXP2

	DO I=0,L1
		J=K-I
		IF (J<=L2.AND.J>=0)THEN
			CALL ELEVAPOL(P1,PS1,L1-I)
			CALL ELEVAPOL(P2,PS2,L2-J)
			CALL PROPOL(PS1,PS2,PHAUX)

			NUM=(FACT(L1)/(FACT(I)*FACT(L1-I)))*(FACT(L2)/(FACT(J)*FACT(L2-J)))*FKGAMMA(GAMA,K)*(GAMA**0.5Q0)
			CALL NUMPROPOL(NUM,PHAUX)
			CALL SUMPOL(PHAUX,PH,PHAUX1)
			PH=PHAUX1
		ENDIF
	ENDDO
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA POTENCIA M'ESIMA DE UN POLINOMIO
!*******************************************************************
	RECURSIVE SUBROUTINE ELEVAPOL(PIN,POUT,M)
	USE ESTRUCT
	INTEGER*4 M
	TYPE(POLINOMIO)::PIN,POUT,POUT1

	IF(M==0)THEN
		POUT.C(0)=1.Q0
		POUT.GRADO=0
		RETURN
	ENDIF	

	CALL ELEVAPOL(PIN,POUT,M-1)

	IF(M==1)THEN
		POUT=PIN
		RETURN
	ENDIF

	CALL PROPOL(PIN,POUT,POUT1)
	POUT=POUT1


	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA EL PRODUCTO DE DOS POLINOMIOS
!*******************************************************************
	SUBROUTINE PROPOL(P1,P2,P)
	USE ESTRUCT
	USE GLOBAL
	INTEGER*4 I,J,IND
	TYPE (POLINOMIO)::P1,P2,P
	CHARACTER*ILONG LEERVALOR,CADIDIOMA,CAD

	P.GRADO=0
	DO I=0,MAXGRAD
		P.C(I)=0.Q0
	ENDDO
	
	P.GRADO=P1.GRADO+P2.GRADO
	IF (P.GRADO>MAXGRAD)THEN 
		CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1216')
		CAD=' '
		CALL MENSAJES(CADIDIOMA,CAD,0.Q0)
		STOP
	ENDIF

	DO I=0,P1.GRADO
		DO J=0,P2.GRADO
			IND=I+J
			P.C(IND)=P.C(IND)+P1.C(I)*P2.C(J)
		ENDDO
	ENDDO

	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA EL PRODUCTO DE UN NUMERO POR UN POLINOMIO
!*******************************************************************
	SUBROUTINE NUMPROPOL(NUMERO,P)
	USE ESTRUCT
	INTEGER*4 I,J,IND
	REAL*16 NUMERO
	TYPE (POLINOMIO)::P
	
	DO I=0,P.GRADO
		P.C(I)=P.C(I)*NUMERO
	ENDDO
			
	END

!*******************************************************************
!   SUBRUTINA QUE CALCULA LA SUMA DE DOS POLINOMIOS
!*******************************************************************
	SUBROUTINE SUMPOL(P1,P2,P)
	USE ESTRUCT
	INTEGER*4 I,J,IND
	REAL*16 NUMERO
	TYPE (POLINOMIO)::P1,P2,P
	
	P.GRADO=0
	DO I=0,MAXGRAD
		P.C(I)=0.Q0
	ENDDO
	
	P.GRADO=MAX(P1.GRADO,P2.GRADO)
	DO I=0,P.GRADO
		P.C(I)=P1.C(I)+P2.C(I)
	ENDDO
			
	END

! ---------------------------------------------------
! --------- SUBROGRAMA PARA CALCULAR (p,q|r,s) 
! ---------(CON GAUSSIANAS)
! ---------------------------------------------------
	SUBROUTINE INTGSS_BI(MAT,NUMINT)
	USE ESTRUCT
	USE GLOBAL
	IMPLICIT REAL*16(A-H,O-Z)                  
	INTEGER*4 MAT,NUMINT,ERROR,KVAR
	INTEGER*4 NP,NQ,NR,NS,PASO,CONTPASO !,IP,IQ,IR,IS
	REAL*16 INTEG !,LEERVALOR_REAL
	CHARACTER*ILONG LEERVALOR,CADIDIOMA,CAD !,INTTOSTR
	INTEGER CAL_BI1,CAL_BI2
    CHARACTER*ILONG INTTOSTR

	CADIDIOMA=LEERVALOR('idioma.lng',IDIOMA,'1213')		
    
	TMONO=DBLE(7.Q0*N*(N+1)) !SON 7 TIPOS DE INTEGRALES MONO: S,T,V,H,X,Y,Z
    TBIEL=0.Q0
	IF (NEL>1)TBIEL=2.7Q0*DBLE(N_INT_BI)
    TTOTAL=TMONO+TBIEL
    TIEN=TMONO
	
	PASO=N_INT_BI/N
	CONTPASO=0
    
	NPQ=0
    K=0
	MAT=4
	DO NQ=1,N
		DO NP=1,NQ
			NPQ=NPQ+1
			NRS=0
            CAL_BI1=1
            IF(NQ.NE.NP)THEN
                IF(((FB(NQ).X-FB(NP).X)**2+(FB(NQ).Y-FB(NP).Y)**2+(FB(NQ).Z-FB(NP).Z)**2).GT.(FB(NQ).RECOR.R1+FB(NP).RECOR.R1)**2)THEN
                    CAL_BI1=0
                ENDIF
            ENDIF
			DO NS=1,N
				DO NR=1,NS
					NRS=NRS+1
                    CAL_BI2=1
                    IF(NR.NE.NS)THEN
                        IF(((FB(NR).X-FB(NS).X)**2+(FB(NR).Y-FB(NS).Y)**2+(FB(NR).Z-FB(NS).Z)**2).GT.(FB(NR).RECOR.R1+FB(NS).RECOR.R1)**2)THEN
                            CAL_BI2=0
                        ENDIF
                    ENDIF
					IF(NRS>NPQ)GOTO 10
					K=K+1
                    
					IF(K>NUMINT)THEN
						TIEN=TIEN+2.7Q0
						PCTO=1.Q02*TIEN/TTOTAL
						WRITE(CAD,'(A1,2I2,A2,2I2,A1,A,F5.1,A)')'(',NP,NQ,' |',NR,NS,')',' (',PCTO,'%)'
						CALL MENSAJES(CADIDIOMA,CAD,PCTO)
						
						KVAR=INDK(NP,NQ,NR,NS)
                        
                        IF(BIELEC.EQ.1.AND.(CAL_BI1.EQ.0.OR.CAL_BI2.EQ.0))THEN
                            INTEG=0.Q0
                        ELSE
						    CALL CALCULA_GSS('J',NP,NQ,NR,NS,INTEG)
                            NINTBI=NINTBI+1
                        ENDIF

						R(KVAR)=INTEG*FB(NP).ANOR*FB(NQ).ANOR*FB(NR).ANOR*FB(NS).ANOR
						NUMINT=K
						CONTPASO=CONTPASO+1
						IF(CONTPASO>PASO)THEN
							CONTPASO=0
							CALL ESCINT(MAT,NUMINT)
						ENDIF
					!ELSE
					!	CALL IND_PQRS(KVAR,IP,IQ,IR,IS)
					!	R(KVAR)=LEERVALOR_REAL(DIR.INT,'BIELECTRONICA','R('//TRIM(INTTOSTR(IP))//','//TRIM(INTTOSTR(IQ))//','//TRIM(INTTOSTR(IR))//','//TRIM(INTTOSTR(IS))//')')
					ENDIF
				END DO
			END DO
10			CONTINUE
		END DO
	END DO

	IF(CONTPASO>0)CALL ESCINT(MAT,NUMINT)

	END

!********************************************************************
!	SUBROUTINA QUE REALIZA LAS INTEGRALES BIELECTRÓNICAS (DE UNA CAPA) 
!   CON FUNCIONES DE BASE GAUSSIANAS
!********************************************************************
	  
	  SUBROUTINE SOLOUNA_BI_GSS(N1,N2,N3,N4,INTEG)
      USE GLOBAL
	  USE ESTRUCT
	  IMPLICIT REAL*16 (A-H,O-Z)
	  REAL*16 INTEG
	  INTEGER*4 N1,N2,N3,N4
	  INTEGER*4 I,J,K,L

	    INTEG=0.0Q0  
	    DO I=1,FB(N1).NSFB
			DO J=1,FB(N2).NSFB
				DO K=1,FB(N3).NSFB
					DO L=1,FB(N4).NSFB
						INTEG= INTEG + GAUSS(N1,I).GCOEF*GAUSS(N2,J).GCOEF*GAUSS(N3,K).GCOEF*GAUSS(N4,L).GCOEF*GAUSS(N1,I).GNOR*GAUSS(N2,J).GNOR*GAUSS(N3,K).GNOR*GAUSS(N4,L).GNOR*RG(N1,N2,N3,N4,I,J,K,L)
					END DO
				END DO
			END DO
		END DO	  

1	FORMAT('CALCULANDO LA INTEGRAL: <',2I2,'| J |',2I2,'>')

END

!*****************************************************************************!
!        SUBRUTINA QUE CALCULA UNA INTEGRAL BIELECTRONICA DE REPULSION        !
!   CUATRO GAUSSIANAS * DOS VARIABLES DE INTEGRACION * 1-4 CENTROS DISTINTOS  !
!*****************************************************************************!
	REAL*16 FUNCTION RG(NB1,NB2,NB3,NB4,NG1,NG2,NG3,NG4)
	USE GLOBAL
	USE ESTRUCT
	INTEGER*4 NB1,NB2,NB3,NB4,NG1,NG2,NG3,NG4
	INTEGER*4 IL1,IL2,IL3,IL4,IM1,IM2,IM3,IM4,IN1,IN2,IN3,IN4,I
	INTEGER*4 THETAx,THETAy,THETAz,Ix,Iy,Iz,Jx,Jy,Jz,Hx,Hy,Hz
	INTEGER*4 PSI,FIx,FIy,FIz,Kx,Ky,Kz,Valor,Ipolx,Npolx,Ipoly,Npoly,Ipolz,Npolz
	INTEGER*4 mx,nx,Kx2,Lx,my,ny,Ky2,Ly,mz,nz,Kz2,Lz
	REAL*16 GEXP1,GEXP2,GEXP3,GEXP4,GAMA,DLTA,K1,K2,PC2,INT,INT1,FV(0:16) !,ANOR1,ANOR2
	REAL*16 E1,E2,PQ2,Aux1,Aux2,Aux3,Aux4,Aux5,Aux6,Apolx(10),Apoly(10),Apolz(10)
	RECORD/XYZ/A,B,AB,P,PAA,PBB,PCC
	RECORD/XYZ/C,D,CD,Q,QCC,QDD
	TYPE(POLINOMIO)::PX,PY,PZ,PAUX,POL,P1T,PT,PTOTAL
    REAL*16 FKH,FKGAMMA,NUM_COMB
	
	RG = 0.0Q0
    Valor=0
    Npolx = 8
	Npoly = 8
	Npolz = 8
	
	IF (NB1.NE.NB2)THEN
		Kx2=GAUSS(NB1,NG1).GNX
		Lx=GAUSS(NB2,NG2).GNX
		ky2=GAUSS(NB1,NG1).GNY
		Ly=GAUSS(NB2,NG2).GNY
		Kz2=GAUSS(NB1,NG1).GNZ
		Lz=GAUSS(NB2,NG2).GNZ
	ELSE
		Kx2=GAUSS(NB1,NG1).GNX
		Lx=GAUSS(NB2,0).GNX
		Ky2=GAUSS(NB1,NG1).GNY
		Ly=GAUSS(NB2,0).GNY
		Kz2=GAUSS(NB1,NG1).GNZ
		Lz=GAUSS(NB2,0).GNZ
	ENDIF
	IF (NB3.NE.NB4)THEN
		mx=GAUSS2(NB3,NG3).GNX
		nx=GAUSS2(NB4,NG4).GNX
		my=GAUSS2(NB3,NG3).GNY
		ny=GAUSS2(NB4,NG4).GNY
		mz=GAUSS2(NB3,NG3).GNZ
		nz=GAUSS2(NB4,NG4).GNZ
	ELSE
		mx=GAUSS2(NB3,NG3).GNX
		nx=GAUSS2(NB4,0).GNX
		my=GAUSS2(NB3,NG3).GNY
		ny=GAUSS2(NB4,0).GNY
		mz=GAUSS2(NB3,NG3).GNZ
		nz=GAUSS2(NB4,0).GNZ
	ENDIF

	!IF((Kx2==Lx).AND.(Kx2==mx).AND.(Kx2==nx).AND.(Kx2==1).AND.((Ky2+Kz2+Ly+Lz+my+mz+ny+nz)==0))THEN
	IF ((Kx2+Lx+Ky2+Ly+Kz2+Lz)==(mx+nx+my+ny+mz+nz).AND.((Kx2+Lx+Ky2+Ly+Kz2+Lz)==2))THEN
		IF((GAUSS(NB3,NG3).GEXP+GAUSS(NB4,NG4).GEXP)>(GAUSS(NB1,NG1).GEXP+GAUSS(NB2,NG2).GEXP))THEN
		!If ((Kx2+Lx+Ky2+Ly+Kz2+Lz)<(mx+nx+my+ny+mz+nz))THEN
			I=NB1
			NB1=NB3
			NB3=I
			I=NB2
			NB2=NB4
			NB4=I
			I=NG1
			NG1=NG3
			NG3=I
			I=NG2
			NG2=NG4
			NG4=I
			I=Kx2
			Kx2=mx
			mx=I
			I=Ky2
			Ky2=my
			my=I
			I=Kz2
			Kz2=mz
			mz=I
			I=Lx
			Lx=nx
			nx=I
			I=Ly
			Ly=ny
			ny=I
			I=Lz
			Lz=nz
			nz=I
			Valor=1
		End If

		GEXP1=GAUSS(NB1,NG1).GEXP
		GEXP2=GAUSS(NB2,NG2).GEXP
		GEXP3=GAUSS(NB3,NG3).GEXP
		GEXP4=GAUSS(NB4,NG4).GEXP

		A.X=FB(NB1).X
		A.Y=FB(NB1).Y
		A.Z=FB(NB1).Z
		B.X=FB(NB2).X
		B.Y=FB(NB2).Y
		B.Z=FB(NB2).Z
		C.X=FB(NB3).X
		C.Y=FB(NB3).Y
		C.Z=FB(NB3).Z
		D.X=FB(NB4).X
		D.Y=FB(NB4).Y
		D.Z=FB(NB4).Z

		E1=GEXP1+GEXP2
		E2=GEXP3+GEXP4

		AB.X=A.X-B.X
		AB.Y=A.Y-B.Y
		AB.Z=A.Z-B.Z
		CD.X=C.X-D.X
		CD.Y=C.Y-D.Y
		CD.Z=C.Z-D.Z

		K1=QEXP(-((GEXP1*GEXP2)/E1)*(AB.X**2+AB.Y**2+AB.Z**2))
		K2=QEXP(-((GEXP3*GEXP4)/E2)*(CD.X**2+CD.Y**2+CD.Z**2))

		P.X=(GEXP1*A.X+GEXP2*B.X)/E1
		P.Y=(GEXP1*A.Y+GEXP2*B.Y)/E1
		P.Z=(GEXP1*A.Z+GEXP2*B.Z)/E1
		Q.X=(GEXP3*C.X+GEXP4*D.X)/E2
		Q.Y=(GEXP3*C.Y+GEXP4*D.Y)/E2
		Q.Z=(GEXP3*C.Z+GEXP4*D.Z)/E2

		PAA.X=P.X-A.X
		PAA.Y=P.Y-A.Y
		PAA.Z=P.Z-A.Z
		PBB.X=P.X-B.X
		PBB.Y=P.Y-B.Y
		PBB.Z=P.Z-B.Z
		QCC.X=Q.X-C.X
		QCC.Y=Q.Y-C.Y
		QCC.Z=Q.Z-C.Z
		QDD.X=Q.X-D.X
		QDD.Y=Q.Y-D.Y
		QDD.Z=Q.Z-D.Z

		PQ2 = (P.X - Q.X)**2 + (P.Y - Q.Y)**2 + (P.Z - Q.Z)**2

		CALL FREQ16(((E1*E2)/(E1+E2))*PQ2,FV)

		INT  = 0.0Q0
		AUX1 = 0.0Q0
		AUX2 = 0.0Q0
		AUX3 = 0.0Q0
		AUX4 = 0.0Q0
		AUX5 = 0.0Q0
		AUX6 = 0.0Q0

		DO Kx=0,(mx + nx)
		  DO Ky=0,(my + ny)
			DO Kz=0,(mz + nz)
			  DO Ix=0,Kx,2
				DO Iy=0,Ky,2
				  DO Iz=0,Kz,2

					IF((FKH(mx,nx,0,QCC.X,QDD.X,0.0Q0,Kx)*FKH(my,ny,0,QCC.Y,QDD.Y,0.0Q0,Ky)*FKH(mz,nz,0,QCC.Z,QDD.Z,0.0Q0,Kz)).NE.0.0Q0)THEN

						AUX2=0.0Q0
						DO Hx=0,(Kx2 + Lx)
						  DO Hy=0,(Ky2 + Ly)
							DO Hz=0,(Kz2 + Lz)
							  
							IF((FKH(Kx2,Lx,0,PAA.X,PBB.X,0.0Q0,Hx)*FKH(Ky2,Ly,0,PAA.Y,PBB.Y,0.0Q0,Hy)*FKH(Kz2,Lz,0,PAA.Z,PBB.Z,0.0Q0,Hz)).NE.0.0Q0)THEN

								  AUX3=0.0Q0
								  DO THETAx=0,Hx
									DO THETAy=0,Hy
									  DO THETAz=0,Hz  
										DO Jx=0,(Kx-Ix)
										  DO Jy=0,(Ky-Iy)
											DO Jz=0,(Kz-Iz)
											   
												IF(((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz)).NE.0.0Q0)THEN

												  AUX4=0.0Q0
												  IF((JMOD(THETAx+Jx,2)==0).AND.(JMOD(THETAy+Jy,2)==0).AND.(JMOD(THETAz+Jz,2)==0))THEN
												  
														
														!IF(((THETAx-Jx-Ix)<0).OR.((THETAy-Jy-Iy)<0).OR.((THETAz-Jz-Iz)<0).OR.((THETAx-Jx-Ix)>2).OR.((THETAy-Jy-Iy)>2).OR.((THETAz-Jz-Iz)>2))THEN
														IF(((THETAx-Jx-Ix)<0).OR.((THETAy-Jy-Iy)<0).OR.((THETAz-Jz-Iz)<0).OR.((Kx+Ky+Kz+Hx+Hy+Hz+Ipolx+FIy+FIz-(((Ix+Iy+Iz)/2)+THETAx+THETAy+THETAz))>12))THEN
														
															IF(((Kx+Ky+Kz+Hx+Hy+Hz+Ipolx+FIy+FIz-(((Ix+Iy+Iz)/2)+THETAx+THETAy+THETAz))>12).OR.((THETAx-Jx-Ix)>2).OR.((THETAy-Jy-Iy)>2).OR.((THETAz-Jz-Iz)>2))THEN

															  CALL qromb(0.0Q0,.99999999999999Q0,AUX4,(E1+E2),E2,(THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2,-(Ix+Iy+Iz)/2,2*((Kx+Ky+Kz)+(Hx+Hy+Hz)-(Ix+Iy+Iz)-(THETAx+THETAy+THETAz)),((E1*E2)/(E1+E2))*PQ2)
															  
                                                              AUX4=AUX4*(E1+E2)**((THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2)
															  
															  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
															  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
															  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
															  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
															  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
															  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(((THETAx+THETAy+THETAz)+(Jx+Jy+Jz))/2.0Q0) -1.5Q0 -(Ix+Iy+Iz))
															  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
															  AUX3 = AUX3 + AUX4

																																																						  
															ELSE IF(((THETAx-Jx-Ix)<0).AND.((THETAy-Jy-Iy)>=0).AND.((THETAz-Jz-Iz)>=0))THEN

																! CORRECCION POLINOMICA:
																  CALL APOLi_COEF(-(THETAx-Jx-Ix)/2,Apolx)
																  DO Ipolx=0, Npolx
																	DO FIy=0,(THETAy-Iy-Jy)/2
																	  DO FIz=0,(THETAz-Iz-Jz)/2
																		  
																		  AUX5=0.0Q0
																		  DO PSI=0,(Ipolx+FIy+FIz)+((Ix+Iy+Iz)/2)
																			AUX6 = NUM_COMB((Ipolx+FIy+FIz)+((Ix+Iy+Iz)/2),PSI)*(-1)**((Ipolx+FIy+FIz)+((Ix+Iy+Iz)/2)-PSI)
																			AUX6 = AUX6 * FV((Kx+Ky+Kz)+(Hx+Hy+Hz)+(Ipolx+FIy+FIz)-((Ix+Iy+Iz)/2)-(THETAx+THETAy+THETAz)-PSI)
																			AUX5 = AUX5 + AUX6
																			
																		  END DO

																		AUX5 = AUX5 *Apolx(Ipolx+1)*NUM_COMB((THETAy-Iy-Jy)/2,FIy)*NUM_COMB((THETAz-Iz-Jz)/2,FIz)
																		AUX5 = AUX5 * (E2**(Ipolx+FIy+FIz))*E1**(-(Ipolx+FIy+FIz))
																		AUX4 = AUX4 + AUX5
																		
																	  END DO
																	END DO
																  END DO
																  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
																  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
																  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
																  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
																  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
																  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(Jx+Jy+Jz) -1.5Q0 -1.5Q0*(Ix+Iy+Iz))
																  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
																  AUX3 = AUX3 + AUX4

															ELSE IF(((THETAx-Jx-Ix)>=0).AND.((THETAy-Jy-Iy)<0).AND.((THETAz-Jz-Iz)>=0))THEN

																! CORRECCION POLINOMICA:
																CALL APOLi_COEF(-(THETAy-Jy-Iy)/2,Apoly)
																  DO FIx=0,(THETAx-Ix-Jx)/2
																	 DO Ipoly=0, Npoly
																	  DO FIz=0,(THETAz-Iz-Jz)/2
																		  
																		  AUX5=0.0Q0
																		  DO PSI=0,(Ipoly+FIx+FIz)+((Ix+Iy+Iz)/2)
																			AUX6 = NUM_COMB((Ipoly+FIx+FIz)+((Ix+Iy+Iz)/2),PSI)*(-1)**((Ipoly+FIx+FIz)+((Ix+Iy+Iz)/2)-PSI)
																			AUX6 = AUX6 * FV((Kx+Ky+Kz)+(Hx+Hy+Hz)+(Ipoly+FIx+FIz)-((Ix+Iy+Iz)/2)-(THETAx+THETAy+THETAz)-PSI)
																			AUX5 = AUX5 + AUX6
																			
																		  END DO

																		AUX5 = AUX5 *Apoly(Ipoly+1)*NUM_COMB((THETAx-Ix-Jx)/2,FIx)*NUM_COMB((THETAz-Iz-Jz)/2,FIz)
																		AUX5 = AUX5 * (E2**(Ipoly+FIx+FIz))*E1**(-(Ipoly+FIx+FIz))
																		AUX4 = AUX4 + AUX5
																		
																	  END DO
																	END DO
																  END DO
																  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
																  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
																  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
																  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
																  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
																  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(Jx+Jy+Jz) -1.5Q0 -1.5Q0*(Ix+Iy+Iz))
																  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
																  AUX3 = AUX3 + AUX4

															ELSE IF(((THETAx-Jx-Ix)>=0).AND.((THETAy-Jy-Iy)>=0).AND.((THETAz-Jz-Iz)<0))THEN

																! CORRECCION POLINOMICA:
																  CALL APOLi_COEF(-(THETAz-Jz-Iz)/2,Apolz)
																  DO FIx=0,(THETAx-Ix-Jx)/2
																	DO FIy=0,(THETAy-Iy-Jy)/2
																	  DO Ipolz=0, Npolz
																		  
																		  AUX5=0.0Q0
																		  DO PSI=0,(Ipolz+FIy+FIx)+((Ix+Iy+Iz)/2)
																			AUX6 = NUM_COMB((Ipolz+FIy+FIx)+((Ix+Iy+Iz)/2),PSI)*(-1)**((FIx+FIy+Ipolz)+((Ix+Iy+Iz)/2)-PSI)
																			AUX6 = AUX6 * FV((Kx+Ky+Kz)+(Hx+Hy+Hz)+(Ipolz+FIy+FIx)-((Ix+Iy+Iz)/2)-(THETAx+THETAy+THETAz)-PSI)
																			AUX5 = AUX5 + AUX6
																			
																		  END DO

																		AUX5 = AUX5 *Apolz(Ipolz+1)*NUM_COMB((THETAy-Iy-Jy)/2,FIy)*NUM_COMB((THETAx-Ix-Jx)/2,FIx)
																		AUX5 = AUX5 * (E2**(Ipolz+FIy+FIx))*E1**(-(Ipolz+FIy+FIx))
																		AUX4 = AUX4 + AUX5
																		
																	  END DO
																	END DO
																  END DO
																  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
																  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
																  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
																  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
																  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
																  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(Jx+Jy+Jz) -1.5Q0 -1.5Q0*(Ix+Iy+Iz))
																  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
																  AUX3 = AUX3 + AUX4
															ELSE 
															  CALL qromb(0.0Q0,.99999999999999Q0,AUX4,(E1+E2),E2,(THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2,-(Ix+Iy+Iz)/2,2*((Kx+Ky+Kz)+(Hx+Hy+Hz)-(Ix+Iy+Iz)-(THETAx+THETAy+THETAz)),((E1*E2)/(E1+E2))*PQ2)
															  AUX4=AUX4*(E1+E2)**((THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2)										  
															  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
															  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
															  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
															  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
															  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
															  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(((THETAx+THETAy+THETAz)+(Jx+Jy+Jz))/2.0Q0) -1.5Q0 -(Ix+Iy+Iz))
															  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
															  AUX3 = AUX3 + AUX4

															END IF

														ELSE  
															  
															  DO FIx=0,(THETAx-Ix-Jx)/2
																DO FIy=0,(THETAy-Iy-Jy)/2
																  DO FIz=0,(THETAz-Iz-Jz)/2
																	  
																	  AUX5=0.0Q0
																	  DO PSI=0,(FIx+FIy+FIz)+((Ix+Iy+Iz)/2)
																		AUX6 = NUM_COMB((FIx+FIy+FIz)+((Ix+Iy+Iz)/2),PSI)*(-1)**((FIx+FIy+FIz)+((Ix+Iy+Iz)/2)-PSI)
																		AUX6 = AUX6 * FV((Kx+Ky+Kz)+(Hx+Hy+Hz)+(FIx+FIy+FIz)-((Ix+Iy+Iz)/2)-(THETAx+THETAy+THETAz)-PSI)
																		AUX5 = AUX5 + AUX6
																		
																	  END DO

																	AUX5 = AUX5 * NUM_COMB((THETAx-Ix-Jx)/2,FIx)*NUM_COMB((THETAy-Iy-Jy)/2,FIy)*NUM_COMB((THETAz-Iz-Jz)/2,FIz)
																	AUX5 = AUX5 * (E2**(FIx+FIy+FIz))*E1**(-(FIx+FIy+FIz))
																	AUX4 = AUX4 + AUX5
																	
																  END DO
																END DO
															  END DO
														  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
														  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
														  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
														  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
														  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
														  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(Jx+Jy+Jz) -1.5Q0 -1.5Q0*(Ix+Iy+Iz))
														  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
														  AUX3 = AUX3 + AUX4

														END IF
												  
												  END IF
												END IF

											END DO
										  END DO
										END DO
									  END DO
									END DO
								  END DO
							  
								  AUX3 = AUX3 * FKH(Kx2,Lx,0,PAA.X,PBB.X,0.0Q0,Hx)*FKH(Ky2,Ly,0,PAA.Y,PBB.Y,0.0Q0,Hy)*FKH(Kz2,Lz,0,PAA.Z,PBB.Z,0.0Q0,Hz)
								  AUX2 = AUX2 + AUX3
							  
							  END IF
							   
							END DO
						  END DO
						END DO

						AUX2 = AUX2 * FKH(mx,nx,0,QCC.X,QDD.X,0.0Q0,Kx)*FKH(my,ny,0,QCC.Y,QDD.Y,0.0Q0,Ky)*FKH(mz,nz,0,QCC.Z,QDD.Z,0.0Q0,Kz)
						AUX2 = AUX2 * NUM_COMB(Kx,Ix)*NUM_COMB(Ky,Iy)*NUM_COMB(Kz,Iz)
						AUX2 = AUX2 * FKGAMMA(1.0Q0,Ix)*FKGAMMA(1.0Q0,Iy)*FKGAMMA(1.0Q0,Iz)
						AUX1 = AUX1 + AUX2

					END IF

				  END DO
				END DO
			  END DO
			END DO
		  END DO
		END DO 

		RG = AUX1 * 2.0Q0 * QSQRT((E1*E2)/(E1+E2)) * K1 * K2 / QSQRT(PI)

	ELSE

		!IF((GAUSS(NB3,NG3).GEXP+GAUSS(NB4,NG4).GEXP)>(GAUSS(NB1,NG1).GEXP+GAUSS(NB2,NG2).GEXP))THEN
		IF ((Kx2+Lx+Ky2+Ly+Kz2+Lz)<(mx+nx+my+ny+mz+nz))Then
			I=NB1
			NB1=NB3
			NB3=I
			I=NB2
			NB2=NB4
			NB4=I
			I=NG1
			NG1=NG3
			NG3=I
			I=NG2
			NG2=NG4
			NG4=I
			I=Kx2
			Kx2=mx
			mx=I
			I=Ky2
			Ky2=my
			my=I
			I=Kz2
			Kz2=mz
			mz=I
			I=Lx
			Lx=nx
			nx=I
			I=Ly
			Ly=ny
			ny=I
			I=Lz
			Lz=nz
			nz=I
			Valor=1
		End If

		GEXP1=GAUSS(NB1,NG1).GEXP
		GEXP2=GAUSS(NB2,NG2).GEXP
		GEXP3=GAUSS(NB3,NG3).GEXP
		GEXP4=GAUSS(NB4,NG4).GEXP

		A.X=FB(NB1).X
		A.Y=FB(NB1).Y
		A.Z=FB(NB1).Z
		B.X=FB(NB2).X
		B.Y=FB(NB2).Y
		B.Z=FB(NB2).Z
		C.X=FB(NB3).X
		C.Y=FB(NB3).Y
		C.Z=FB(NB3).Z
		D.X=FB(NB4).X
		D.Y=FB(NB4).Y
		D.Z=FB(NB4).Z

		E1=GEXP1+GEXP2
		E2=GEXP3+GEXP4

		AB.X=A.X-B.X
		AB.Y=A.Y-B.Y
		AB.Z=A.Z-B.Z
		CD.X=C.X-D.X
		CD.Y=C.Y-D.Y
		CD.Z=C.Z-D.Z

		K1=QEXP(-((GEXP1*GEXP2)/E1)*(AB.X**2+AB.Y**2+AB.Z**2))
		K2=QEXP(-((GEXP3*GEXP4)/E2)*(CD.X**2+CD.Y**2+CD.Z**2))

		P.X=(GEXP1*A.X+GEXP2*B.X)/E1
		P.Y=(GEXP1*A.Y+GEXP2*B.Y)/E1
		P.Z=(GEXP1*A.Z+GEXP2*B.Z)/E1
		Q.X=(GEXP3*C.X+GEXP4*D.X)/E2
		Q.Y=(GEXP3*C.Y+GEXP4*D.Y)/E2
		Q.Z=(GEXP3*C.Z+GEXP4*D.Z)/E2

		PAA.X=P.X-A.X
		PAA.Y=P.Y-A.Y
		PAA.Z=P.Z-A.Z
		PBB.X=P.X-B.X
		PBB.Y=P.Y-B.Y
		PBB.Z=P.Z-B.Z
		QCC.X=Q.X-C.X
		QCC.Y=Q.Y-C.Y
		QCC.Z=Q.Z-C.Z
		QDD.X=Q.X-D.X
		QDD.Y=Q.Y-D.Y
		QDD.Z=Q.Z-D.Z

		PQ2 = (P.X - Q.X)**2 + (P.Y - Q.Y)**2 + (P.Z - Q.Z)**2

		CALL FREQ16(((E1*E2)/(E1+E2))*PQ2,FV)

		INT  = 0.0Q0
		AUX1 = 0.0Q0
		AUX2 = 0.0Q0
		AUX3 = 0.0Q0
		AUX4 = 0.0Q0
		AUX5 = 0.0Q0
		AUX6 = 0.0Q0
		
		DO Kx=0,(mx + nx)
		  DO Ky=0,(my + ny)
			DO Kz=0,(mz + nz)
			  DO Ix=0,Kx,2
				DO Iy=0,Ky,2
				  DO Iz=0,Kz,2

					IF((FKH(mx,nx,0,QCC.X,QDD.X,0.0Q0,Kx)*FKH(my,ny,0,QCC.Y,QDD.Y,0.0Q0,Ky)*FKH(mz,nz,0,QCC.Z,QDD.Z,0.0Q0,Kz)).NE.0.0Q0)THEN

						AUX2=0.0Q0
						DO Hx=0,(Kx2 + Lx)
						  DO Hy=0,(Ky2 + Ly)
							DO Hz=0,(Kz2 + Lz)
							  
							IF((FKH(Kx2,Lx,0,PAA.X,PBB.X,0.0Q0,Hx)*FKH(Ky2,Ly,0,PAA.Y,PBB.Y,0.0Q0,Hy)*FKH(Kz2,Lz,0,PAA.Z,PBB.Z,0.0Q0,Hz)).NE.0.0Q0)THEN

								  AUX3=0.0Q0
								  DO THETAx=0,Hx
									DO THETAy=0,Hy
									  DO THETAz=0,Hz  
										DO Jx=0,(Kx-Ix)
										  DO Jy=0,(Ky-Iy)
											DO Jz=0,(Kz-Iz)
											   
												IF(((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz)).NE.0.0Q0)THEN

												  AUX4=0.0Q0
												  IF((JMOD(THETAx+Jx,2)==0).AND.(JMOD(THETAy+Jy,2)==0).AND.(JMOD(THETAz+Jz,2)==0))THEN
												  
														
														IF(((THETAx-Jx-Ix)<0).OR.((THETAy-Jy-Iy)<0).OR.((THETAz-Jz-Iz)<0).OR.((THETAx-Jx-Ix)>2).OR.((THETAy-Jy-Iy)>2).OR.((THETAz-Jz-Iz)>2))THEN
                                                              CALL qromb(0.0Q0,.99999999999999Q0,AUX4,(E1+E2),E2,(THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2,-(Ix+Iy+Iz)/2,2*((Kx+Ky+Kz)+(Hx+Hy+Hz)-(Ix+Iy+Iz)-(THETAx+THETAy+THETAz)),((E1*E2)/(E1+E2))*PQ2)
															  AUX4=AUX4*(E1+E2)**((THETAx-Ix-Jx+THETAy-Iy-Jy+THETAz-Iz-Jz)/2)										  
															  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
															  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
															  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
															  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
															  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
															  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(((THETAx+THETAy+THETAz)+(Jx+Jy+Jz))/2.0Q0) -1.5Q0 -(Ix+Iy+Iz))
															  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
															  AUX3 = AUX3 + AUX4

														ELSE  
															  
															  DO FIx=0,(THETAx-Ix-Jx)/2
																DO FIy=0,(THETAy-Iy-Jy)/2
																  DO FIz=0,(THETAz-Iz-Jz)/2
																	  
																	  AUX5=0.0Q0
																	  DO PSI=0,(FIx+FIy+FIz)+((Ix+Iy+Iz)/2)
																		AUX6 = NUM_COMB((FIx+FIy+FIz)+((Ix+Iy+Iz)/2),PSI)*(-1)**((FIx+FIy+FIz)+((Ix+Iy+Iz)/2)-PSI)
																		AUX6 = AUX6 * FV((Kx+Ky+Kz)+(Hx+Hy+Hz)+(FIx+FIy+FIz)-((Ix+Iy+Iz)/2)-(THETAx+THETAy+THETAz)-PSI)
																		AUX5 = AUX5 + AUX6
																		
																	  END DO

																	AUX5 = AUX5 * NUM_COMB( (THETAx-Ix-Jx)/2,FIx )*NUM_COMB((THETAy-Iy-Jy)/2,FIy)*NUM_COMB((THETAz-Iz-Jz)/2,FIz)
																	AUX5 = AUX5 * (E2**(FIx+FIy+FIz))*E1**(-(FIx+FIy+FIz))
																	AUX4 = AUX4 + AUX5
																	
																  END DO
																END DO
															  END DO
														  AUX4 = AUX4 * NUM_COMB(Hx,THETAx)*NUM_COMB(Hy,THETAy)*NUM_COMB(Hz,THETAz)*NUM_COMB(Kx-Ix,Jx)*NUM_COMB(Ky-Iy,Jy)*NUM_COMB(Kz-Iz,Jz)
														  AUX4 = AUX4 * FKGAMMA(1.0Q0,THETAx+Jx)*FKGAMMA(1.0Q0,THETAy+Jy)*FKGAMMA(1.0Q0,THETAz+Jz)
														  AUX4 = AUX4 * ((P.X - Q.X)**(Hx+Kx-Ix-Jx-THETAx))*((P.Y - Q.Y)**(Hy+Ky-Iy-Jy-THETAy))*((P.Z - Q.Z)**(Hz+Kz-Iz-Jz-THETAz))
														  AUX4 = AUX4 * ((-1)**(Hx-THETAx)) * ((-1)**(Hy-THETAy)) * ((-1)**(Hz-THETAz)) 
														  AUX4 = AUX4 * (E1 + E2)**(-(Kx+Ky+Kz)-(Hx+Hy+Hz)+((THETAx+THETAy+THETAz)/2.0Q0)+(3.0Q0*(Ix+Iy+Iz)/2.0Q0)+0.5Q0*(Jx+Jy+Jz))
														  AUX4 = AUX4 * E1**((Kx+Ky+Kz)-(Jx+Jy+Jz) -1.5Q0 -1.5Q0*(Ix+Iy+Iz))
														  AUX4 = AUX4 * E2**((Hx+Hy+Hz)-(THETAx+THETAy+THETAz)-1.5Q0- 0.5Q0*(Ix+Iy+Iz))
														  AUX3 = AUX3 + AUX4

														END IF
												  
												  END IF
												END IF

											END DO
										  END DO
										END DO
									  END DO
									END DO
								  END DO
							  
								  AUX3 = AUX3 * FKH(Kx2,Lx,0,PAA.X,PBB.X,0.0Q0,Hx)*FKH(Ky2,Ly,0,PAA.Y,PBB.Y,0.0Q0,Hy)*FKH(Kz2,Lz,0,PAA.Z,PBB.Z,0.0Q0,Hz)
								  AUX2 = AUX2 + AUX3
							  
							  END IF
							   
							END DO
						  END DO
						END DO

						AUX2 = AUX2 * FKH(mx,nx,0,QCC.X,QDD.X,0.0Q0,Kx)*FKH(my,ny,0,QCC.Y,QDD.Y,0.0Q0,Ky)*FKH(mz,nz,0,QCC.Z,QDD.Z,0.0Q0,Kz)
						AUX2 = AUX2 * NUM_COMB(Kx,Ix)*NUM_COMB(Ky,Iy)*NUM_COMB(Kz,Iz)
						AUX2 = AUX2 * FKGAMMA(1.0Q0,Ix)*FKGAMMA(1.0Q0,Iy)*FKGAMMA(1.0Q0,Iz)
						AUX1 = AUX1 + AUX2

					END IF

				  END DO
				END DO
			  END DO
			END DO
		  END DO
		END DO 

		RG = AUX1 * 2.0Q0 * QSQRT((E1*E2)/(E1+E2)) * K1 * K2 / QSQRT(PI)

	END IF
	
	IF (Valor==1)Then
		Valor=NB3
		NB3=NB1
		NB1=Valor
		Valor=NB4
		NB4=NB2
		NB2=Valor
		Valor=NG3
		NG3=NG1
		NG1=Valor
		Valor=NG4
    	NG4=NG2
		NG2=Valor
		Valor=0
	End If


END

!*******************************************************************
!   FUNCION PARA CARGAR LOS COEF. DEL AJUSTE POLINOMICO DE (1+X)^n 
!*******************************************************************
	SUBROUTINE APOLi_COEF(Npol,Apol) 
	REAL*16 Apl(36),Apol(10)
	INTEGER*4 II,Npol

		DATA (Apl(II),II=1,9)/ &
			0.9999994526253930, &
			-0.999945817480058, &
			0.9987118907535770, &
			-0.986830777031879, &
			0.9275134001663580, &
			-0.758225406592864, &
			0.4716133659518830, &
			-0.187128150098681, &
			0.0342924242067658/

		DATA (Apl(II),II=10,18)/ &
			0.999996034744715, &
			-1.99960509936601, &
			2.990539107467540, &
			-3.90224911600054, &
			4.453790625028730, &
			-4.13683748457831, &
			2.785030331624890, &
			-1.15965295685945, &
			0.218991229702891/

		DATA (Apl(II),II=19,27)/ &
			0.999984104401159, &
			-2.99840718492133, &
			5.961535489828500, &
			-9.59822072535943, &
			12.71959057239280, &
			-13.0383224000044, &
			9.337169318271660, &
			-4.04021566546778, &
			0.781896819879644/		

		DATA (Apl(II),II=28,36)/ &
			0.999953379194100, &
			-3.99529901961651, &
			9.885545740184880, &
			-18.7909195053876, &
			28.02555348091480, &
			-31.0571978237946, &
			23.36622568776460, &
			-10.4316797941433, &
			2.060347073302990/

	IF(Npol==1)THEN
		DO II=1,9
			Apol(II)=Apl(II)
		END DO
	ELSE IF(Npol==2)THEN
		DO II=10,18
			Apol(II)=Apl(II)
		END DO
	ELSE IF(Npol==3)THEN
		DO II=19,27
			Apol(II)=Apl(II)
		END DO
	ELSE IF(Npol==4)THEN
		DO II=28,36
			Apol(II)=Apl(II)
		END DO
	END IF
	END SUBROUTINE

!*******************************************************************
!   FUNCIÓN QUE CALCULA EL NÚMERO DE COMBINACIONES
!*******************************************************************
	REAL*16 FUNCTION NUM_COMB(N,M)
	INTEGER*4 N,M
    REAL*16 FACT
	
		NUM_COMB = FACT(N) / (FACT(M)*FACT(N-M))
	
	END FUNCTION


!--------------------------------------------------------------------

      FUNCTION F0(Y)
      IMPLICIT REAL*16 (A-H,O-Z)
      PARAMETER (SQRPID2 = .88622692545275794D+00)
      IY = Y
      IF (IY .LT. 10) THEN
         IF (IY .LT. 1) THEN
            IF (Y .LT. .5Q0) THEN
               GO TO 1
            ELSE
               GO TO 2
            ENDIF
         ELSE
            GO TO (11,12,13,14,15,16,17,18,19) IY
         ENDIF
      ELSE
         IF (IY .LT. 30) THEN
            GO TO (21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,30,30) IY-9
         ELSE
            IF (IY .GE. 36) THEN
               GO TO 50
            ELSE
               GO TO (41,41,41,42,42,42) IY-29
            ENDIF
         ENDIF
      ENDIF


!     .00  <=  Y = X**2  <=    .50  (ERR =  .11Q-15 )

    1 CONTINUE
          F0 =        .10000000000000000D+01 &
            + Y* (  -.33333333333331516D+00 &
            + Y* (   .99999999998949790Q-01 &
            + Y* (  -.23809523785948163Q-01 &
            + Y* (   .46296293559961021Q-02 &
            + Y* (  -.75757390269173591Q-03 &
            + Y* (   .10682983542885294Q-03 &
            + Y* (  -.13207053535446224Q-04 &
            + Y* (   .14257719690926019Q-05 &
            + Y* (  -.11441807553445567Q-06 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!     .50  <=  Y = X**2  <=   1.00  (ERR =  .22Q-15 )

    2 CONTINUE
          F0 =        .99999999962990072D+00 &
            + Y* (  -.33333332816904537D+00 &
            + Y* (   .99999967768248599Q-01 &
            + Y* (  -.23809405248590706Q-01 &
            + Y* (   .46293447182599911Q-02 &
            + Y* (  -.75710764597245719Q-03 &
            + Y* (   .10630356057007818Q-03 &
            + Y* (  -.12807452018075921Q-04 &
            + Y* (   .12381443070240885Q-05 &
            + Y* (  -.72493232622768845Q-07 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    1.00  <=  Y = X**2  <=   2.00  (ERR =  .66Q-14 )

   10 CONTINUE
   11 CONTINUE
!       F0 =        .99999983526244696D+00
!   &       + Y* (  -.33333215256424792D+00
!   &       + Y* (   .99996205256127568Q-01
!   &       + Y* (  -.23802313987311439Q-01
!   &       + Y* (   .46206438946631723Q-02
!   &       + Y* (  -.74987454179294599Q-03
!   &       + Y* (   .10221417828956826Q-03
!   &       + Y* (  -.11285618879137537Q-04
!   &       + Y* (   .89881066333463943Q-06
!   &       + Y* (  -.37877538525686231Q-07
!   &               ) ) )   ) ) )   ) ) )
          F0 =        .99999998091971409D+00 &
            + Y* (  -.33333318284264735D+00 &
            + Y* (   .99999462512508491Q-01 &
            + Y* (  -.23808375419726885Q-01 &
            + Y* (   .46279966916220952Q-02 &
            + Y* (  -.75595001218388544Q-03 &
            + Y* (   .10567740225432456Q-03 &
            + Y* (  -.12630536129328105Q-04 &
            + Y* (   .12393693530550030Q-05 &
            + Y* (  -.88658707497388741Q-07 &
            + Y* (   .33863698540451594Q-08 &
                    ) ) )   ) ) )   ) ) )   )
      RETURN

!    2.00  <=  Y = X**2  <=   3.00  (ERR =  .28Q-14 )

   12 CONTINUE
          F0 =        .99998526552730072D+00 &
            + Y* (  -.33327171238907238D+00 &
            + Y* (   .99883634848655867Q-01 &
            + Y* (  -.23678564197610139Q-01 &
            + Y* (   .45320122676621756Q-02 &
            + Y* (  -.70691920567385802Q-03 &
            + Y* (   .88108250783499115Q-04 &
            + Y* (  -.82561340851193117Q-05 &
            + Y* (   .51249591410438958Q-06 &
            + Y* (  -.15592663842849936Q-07 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    3.00  <=  Y = X**2  <=   4.00  (ERR =  .12Q-14 )

   13 CONTINUE
          F0 =        .99979703990879853D+00 &
            + Y* (  -.33272590220051118D+00 &
            + Y* (   .99175688776923968Q-01 &
            + Y* (  -.23139259741893195Q-01 &
            + Y* (   .42660022938689063Q-02 &
            + Y* (  -.61879142307340361Q-03 &
            + Y* (   .68494139804375093Q-04 &
            + Y* (  -.54278753091267181Q-05 &
            + Y* (   .27273951349561462Q-06 &
            + Y* (  -.64897423129066557Q-08 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    4.00  <=  Y = X**2  <=   5.00  (ERR =  .72Q-15 )

   14 CONTINUE
          F0 =        .99882003384001272D+00 &
            + Y* (  -.33056236999584659D+00 &
            + Y* (   .97037713708936962Q-01 &
            + Y* (  -.21901690838531555Q-01 &
            + Y* (   .38035094731898897Q-02 &
            + Y* (  -.50306438788036932Q-03 &
            + Y* (   .49104201975210607Q-04 &
            + Y* (  -.33301970873768424Q-05 &
            + Y* (   .13978179842588799Q-06 &
            + Y* (  -.27281122284727386Q-08 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    5.00  <=  Y = X**2  <=   6.00  (ERR =  .56Q-15 )

   15 CONTINUE
          F0 =        .99582606324123824D+00 &
            + Y* (  -.32521895490966130D+00 &
            + Y* (   .92787680246112711Q-01 &
            + Y* (  -.19924327153830454Q-01 &
            + Y* (   .32104295925457394Q-02 &
            + Y* (  -.38413893283990522Q-03 &
            + Y* (   .33161061737353853Q-04 &
            + Y* (  -.19523134475814471Q-05 &
            + Y* (   .70121749396665979Q-07 &
            + Y* (  -.11585695409862512Q-08 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    6.00  <=  Y = X**2  <=   7.00  (ERR =  .14Q-14 )

   16 CONTINUE
          F0 =        .98904887530487384D+00 &
            + Y* (  -.31513403643986654D+00 &
            + Y* (   .86104407417761139Q-01 &
            + Y* (  -.17335463651651690Q-01 &
            + Y* (   .25644231220852969Q-02 &
            + Y* (  -.27645016482829698Q-03 &
            + Y* (   .21168542577287435Q-04 &
            + Y* (  -.10919932580456231Q-05 &
            + Y* (   .34045934322525236Q-07 &
            + Y* (  -.48486339904325692Q-09 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    7.00  <=  Y = X**2  <=   8.00  (ERR =  .13Q-14 )

   17 CONTINUE
          F0 =        .97966106040421286D+00 &
            + Y* (  -.30303638918487213D+00 &
            + Y* (   .79169066073781241Q-01 &
            + Y* (  -.15013988173082859Q-01 &
            + Y* (   .20644046679802021Q-02 &
            + Y* (  -.20458379239583356Q-03 &
            + Y* (   .14275988858421655Q-04 &
            + Y* (  -.66663855065280520Q-06 &
            + Y* (   .18719657386097507Q-07 &
            + Y* (  -.23920493918467329Q-09 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    8.00  <=  Y = X**2  <=   9.00  (ERR =  .94Q-15 )

   18 CONTINUE
          F0 =        .96287230742191088D+00 &
            + Y* (  -.28401873901101610D+00 &
            + Y* (   .69583582896333526Q-01 &
            + Y* (  -.12192392870589819Q-01 &
            + Y* (   .15298392214206963Q-02 &
            + Y* (  -.13698644761296229Q-03 &
            + Y* (   .85706357111803581Q-05 &
            + Y* (  -.35670720081448579Q-06 &
            + Y* (   .88867993033702988Q-08 &
            + Y* (  -.10039403232867642Q-09 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    9.00  <=  Y = X**2  <=  10.00  (ERR =  .17Q-14 )

   19 CONTINUE
          F0 =        .94547123528639532D+00 &
            + Y* (  -.26638315464869916D+00 &
            + Y* (   .61641053282443632Q-01 &
            + Y* (  -.10105969249413588Q-01 &
            + Y* (   .11775195687099185Q-02 &
            + Y* (  -.97324599300123421Q-04 &
            + Y* (   .55939987851159489Q-05 &
            + Y* (  -.21308716995935366Q-06 &
            + Y* (   .48442529132987281Q-08 &
            + Y* (  -.49816511062663912Q-10 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!   10.00  <=  Y = X**2  <=  12.00  (ERR =  .31Q-14 )

   20 CONTINUE
   21 CONTINUE
!        F0 =        .90690296829152672D+00
!   &       + Y* (  -.23226819470426194D+00
!   &       + Y* (   .48211109938537167Q-01
!   &       + Y* (  -.70177202708147732Q-02
!   &       + Y* (   .72037893988413637Q-03
!   &       + Y* (  -.52152329584158018Q-04
!   &       + Y* (   .26143327496589978Q-05
!   &       + Y* (  -.86575737013446760Q-07
!   &       + Y* (   .17070237022388130Q-08
!   &       + Y* (  -.15198543955184278Q-10
!   &               ) ) )   ) ) )   ) ) )
          F0 =        .93433955665468149D+00 &
            + Y* (  -.25728179045499977D+00 &
            + Y* (   .58468264459866047Q-01 &
            + Y* (  -.95090205650674286Q-02 &
            + Y* (   .11172841155102616Q-02 &
            + Y* (  -.95491726302743464Q-04 &
            + Y* (   .58991314733453914Q-05 &
            + Y* (  -.25721158369973496Q-06 &
            + Y* (   .75212731729620824Q-08 &
            + Y* (  -.13254393388860302Q-09 &
            + Y* (   .10652312898866740Q-11 &
                    ) ) )   ) ) )   ) ) )   )
      RETURN

!   12.00  <=  Y = X**2  <=  14.00  (ERR =  .17Q-14 )

   22 CONTINUE
          F0 =        .85284315742465411D+00 &
            + Y* (  -.19160894962164871D+00 &
            + Y* (   .34592282321813633Q-01 &
            + Y* (  -.43514010303291779Q-02 &
            + Y* (   .38412427317523635Q-03 &
            + Y* (  -.23825783349253712Q-04 &
            + Y* (   .10203766829566982Q-05 &
            + Y* (  -.28805011315021392Q-07 &
            + Y* (   .48332786563685744Q-09 &
            + Y* (  -.36572412148150129Q-11 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!   14.00  <=  Y = X**2  <=  16.00  (ERR =  .15Q-14 )

   23 CONTINUE
          F0 =        .80496263359830067D+00 &
            + Y* (  -.16065789405251224D+00 &
            + Y* (   .25689328581600387Q-01 &
            + Y* (  -.28557488438755597Q-02 &
            + Y* (   .22240641575492869Q-03 &
            + Y* (  -.12154871704656775Q-04 &
            + Y* (   .45821105460280766Q-06 &
            + Y* (  -.11377533660836712Q-07 &
            + Y* (   .16782070114483127Q-09 &
            + Y* (  -.11158028324255426Q-11 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!   16.00  <=  Y = X**2  <=  18.00  (ERR =  .14Q-14 )

   24 CONTINUE
          F0 =        .75724523419521361D+00 &
            + Y* (  -.13358416007137663D+00 &
            + Y* (   .18854564141582306Q-01 &
            + Y* (  -.18481150821608452Q-02 &
            + Y* (   .12680095726590266Q-03 &
            + Y* (  -.61006815106924257Q-05 &
            + Y* (   .20234063146333937Q-06 &
            + Y* (  -.44180543942580789Q-08 &
            + Y* (   .57279643885391958Q-10 &
            + Y* (  -.33461458716299170Q-12 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    18.00  <=  Y = X**2  <=  20.00  (ERR =  .15Q-14 )

   25 CONTINUE
          F0 =        .71892347220945063D+00 &
		    + Y* (  -.11424840922019691D+00 &
            + Y* (   .14516751727833527Q-01 &
            + Y* (  -.12802053477100445Q-02 &
            + Y* (   .78983223950407019Q-04 &
            + Y* (  -.34153496282312796Q-05 &
            + Y* (   .10176112944268619Q-06 &
            + Y* (  -.19951749809742907Q-08 &
            + Y* (   .23217723503188929Q-10 &
            + Y* (  -.12169118070328669Q-12 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    20.00  <=  Y = X**2  <=  22.00  (ERR =  .58Q-15 )

   26 CONTINUE
          F0 =        .64238532785196112D+00 &
            + Y* (  -.80590865134147802Q-01 &
            + Y* (   .79326853912407898Q-02 &
            + Y* (  -.52820032167705342Q-03 &
            + Y* (   .23716084223337148Q-04 &
            + Y* (  -.70494931078394430Q-06 &
            + Y* (   .13060798070294322Q-07 &
            + Y* (  -.12728146244811905Q-09 &
            + Y* (   .24993728162160270Q-12 &
            + Y* (   .39489773066419124Q-14 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    22.00  <=  Y = X**2  <=  24.00  (ERR =  .22Q-15 )

   27 CONTINUE
          F0 =        .59450737009529275D+00 &
            + Y* (  -.62717233437642420Q-01 &
            + Y* (   .49921168137680768Q-02 &
            + Y* (  -.24892957347526202Q-03 &
            + Y* (   .68891792465425250Q-05 &
            + Y* (  -.40494801656920425Q-07 &
            + Y* (  -.40340672929511174Q-08 &
            + Y* (   .14646331774920423Q-09 &
            + Y* (  -.21855943088862921Q-11 &
            + Y* (   .12825557550494886Q-13 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    24.00  <=  Y = X**2  <=  26.00  (ERR =  .31Q-15 )

   28 CONTINUE
          F0 =        .56987850406288421D+00 &
            + Y* (  -.55256490804468254Q-01 &
            + Y* (   .40451281973707476Q-02 &
            + Y* (  -.18578935242474610Q-03 &
            + Y* (   .47602603077049577Q-05 &
            + Y* (  -.28018537433989519Q-07 &
            + Y* (  -.22458390623029731Q-08 &
            + Y* (   .76041049138094115Q-10 &
            + Y* (  -.10466387042041995Q-11 &
            + Y* (   .56522753273784745Q-14 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    26.00  <=  Y = X**2  <=  28.00  (ERR =  .12Q-14 )

   29 CONTINUE
          F0 =        .48734737845696452D+00 &
            + Y* (  -.28552041679046007Q-01 &
            + Y* (   .22362948656635834Q-03 &
            + Y* (   .13139638394946878Q-03 &
            + Y* (  -.12049987925615503Q-04 &
            + Y* (   .56114189922549675Q-06 &
            + Y* (  -.15876999905691938Q-07 &
            + Y* (   .27632610400291611Q-09 &
            + Y* (  -.27368425292448273Q-11 &
            + Y* (   .11863669958362732Q-13 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    28.00  <=  Y = X**2  <=  30.00  (ERR =  .33Q-15 )

   30 CONTINUE
          F0 =        .51730944503076248D+00 &
            + Y* (  -.40473396239673852Q-01 &
            + Y* (   .22610054879897805Q-02 &
            + Y* (  -.66869424416863348Q-04 &
            + Y* (   .13262799056238541Q-06 &
            + Y* (   .68962525174726556Q-07 &
            + Y* (  -.27659946495711674Q-08 &
            + Y* (   .53799523347920321Q-10 &
            + Y* (  -.54991445486896358Q-12 &
            + Y* (   .23705474399280854Q-14 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    30.00  <=  Y = X**2  <=  33.00  (ERR =  .69Q-15 )

   40 CONTINUE
   41 CONTINUE
          F0 =        .52540337044679042D+00 &
            + Y* (  -.44107726856985233Q-01 &
            + Y* (   .29069572445111396Q-02 &
            + Y* (  -.12972200239526753Q-03 &
            + Y* (   .39097499193032492Q-05 &
            + Y* (  -.78250276029899043Q-07 &
            + Y* (   .98310566842553788Q-09 &
            + Y* (  -.66522972361449379Q-11 &
            + Y* (   .11945457346685422Q-13 &
            + Y* (   .71722087721981543Q-16 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    33.00  <=  Y = X**2  <=  36.00  (ERR =  .28Q-15 )

   42 CONTINUE
          F0 =        .49125466927429107D+00 &
            + Y* (  -.35682291804817544Q-01 &
            + Y* (   .19927862556758324Q-02 &
            + Y* (  -.72632137686778569Q-04 &
            + Y* (   .16573902427398185Q-05 &
            + Y* (  -.20383629060251746Q-07 &
            + Y* (   .24363593949557015Q-10 &
            + Y* (   .30572830014180899Q-11 &
            + Y* (  -.40724108102046549Q-13 &
            + Y* (   .17820804409604998Q-15 &
                    ) ) )   ) ) )   ) ) ) 
      RETURN

!    36.00  <=  Y = X**2   (ERR < 0.1Q-16 )

   50 CONTINUE
          F0 = SQRPID2 / QSQRT(Y)
      RETURN
      END

!---------------------------------------------------------------------

      SUBROUTINE FREQ16(Y, FV)
      IMPLICIT REAL*16 (A-H,O-Z)
      PARAMETER (SQRPID2 = .88622692545275794D+00)
      PARAMETER (FACS16 = .51899984530401250D+13)
      DIMENSION FV(0:16)

      EX = QEXP(-Y) 

      IY = Y
      IF (IY .LT. 14) THEN
         IF (IY .LT. 3) THEN
            IF (IY .LT. 1) THEN
               GO TO 1
            ELSE
               GO TO 2
            ENDIF
         ELSE
            IF (IY .LT. 9) THEN
               GO TO 3
            ELSE
               GO TO 4
            ENDIF
         ENDIF
      ELSE
         X = 1.Q0 / Y
         F16ASNT = .5Q0 * FACS16 * QSQRT(X)**33
         IF (IY .LT. 45) THEN
            IF (IY .LT. 25) THEN
               GO TO 5
            ELSE
               GO TO 6
            ENDIF
         ELSE
            IF (IY .LT. 70) THEN
               GO TO 7
            ELSE
               GO TO 8
            ENDIF
         ENDIF
      ENDIF


!      .00  <=  Y   <=   1.00  (ERR =  .87E-17 )

    1 CONTINUE
      FV(16) =        .30303030303030300Q-01 &
            + Y* (  -.28571428571427665Q-01 &
            + Y* (   .13513513513473560Q-01 &
            + Y* (  -.42735042727851140Q-02 &
            + Y* (   .10162601557671175Q-02 &
            + Y* (  -.19379841079345323Q-03 &
            + Y* (   .30864056557044273Q-04 &
            + Y* (  -.42212074536414921Q-05 &
            + Y* (   .50560611618769618Q-06 &
            + Y* (  -.53442020482800041Q-07 &
            + Y* (   .47872062901210445Q-08 &
            + Y* (  -.28334826811733605Q-09 &
                    ) ) )   ) ) )   ) ) )   ) )
      GO TO 1000

!     1.00  <=  Y = X**2  <=   3.00  (ERR =  .23E-16 )

    2 CONTINUE
      FV(16) =        .30303030197034442Q-01 &
            + Y* (  -.28571427647864644Q-01 &
            + Y* (   .13513509840968165Q-01 &
            + Y* (  -.42734954271922134Q-02 &
            + Y* (   .10162457208804647Q-02 &
            + Y* (  -.19378151850541568Q-03 &
            + Y* (   .30849467399861608Q-04 &
            + Y* (  -.42118599658315744Q-05 &
            + Y* (   .50129781853065798Q-06 &
            + Y* (  -.52175296351562954Q-07 &
            + Y* (   .46598441711517808Q-08 &
            + Y* (  -.33808389380472563Q-09 &
            + Y* (   .17824137860162019Q-10 &
            + Y* (  -.54430540399249688Q-12 &
            + Y* (   .47676906443797895Q-14 &
                    ) ) )   ) ) )   ) ) )   ) ) )   ) )
      GO TO 1000

!     3.00  <=  Y = X**2  <=   9.00  (ERR =  .28E-16 )

    3 CONTINUE
      FV(16) =    (   .30303030069788527Q-01 &
            + Y* (   .17316023357085320Q-02 &
            + Y* (   .93599382323440589Q-04 &
            + Y* (   .48005079809509128Q-05 &
            + Y* (   .23390863557814825Q-06 &
            + Y* (   .10969563384228132Q-07 &
            + Y* (   .46523530345127275Q-09 &
            + Y* (   .23772305661293042Q-10 &
            + Y* (   .47705573091919606Q-12 &
            + Y* (   .56514967676318455Q-13 &
            + Y* (   .13252239790960675Q-14 &
            + Y* (  -.13741520380784051Q-15 &
            + Y* (   .20021130369197759Q-16 &
            + Y* (  -.85159942649373777Q-18 &
            + Y* (   .22192282774459261Q-19 &
                    ) ) )   ) ) )   ) ) )   ) ) )   ) ) )  *  EX
      GO TO 1000

!     9.00  <=  Y = X**2  <=  14.00  (ERR =  .11E-15 )

    4 CONTINUE
      FV(16) =    (   .30234343325967066Q-01 &
            + Y* (   .18099700886816230Q-02 &
            + Y* (   .53040015809180164Q-04 &
            + Y* (   .17302510804594540Q-04 &
            + Y* (  -.22871145894161210Q-05 &
            + Y* (   .35074929265840084Q-06 &
            + Y* (  -.28343387196322542Q-07 &
            + Y* (   .10310135936561728Q-08 &
            + Y* (   .94173500189080460Q-10 &
            + Y* (  -.17350898930445473Q-10 &
            + Y* (   .13952688463546135Q-11 &
            + Y* (  -.69178873027346169Q-13 &
            + Y* (   .22048091650520114Q-14 &
            + Y* (  -.41852553841580497Q-16 &
            + Y* (   .37331733334101028Q-18 &
                    ) ) )   ) ) )   ) ) )   ) ) )   ) ) )  *  EX
      GO TO 1000

!    14.00  <=  Y = X**2  <=  25.00  (ERR =  .74E-14 )

    5 CONTINUE
      FV(16) = F16ASNT  &
            -    (   .11896495978181434Q-04 &
            + X* (   .99686381266227586D+00 &
            + X* (   .15882877411721333D+02 &
            + X* (   .19605253321865928D+03 &
            + X* (   .45098319164824434D+04 &
            + X* (  -.17169209736985107D+05 &
            + X* (   .19771128774946721D+07 &
            + X* (  -.28243784401855845D+08 &
            + X* (   .57917770826073742D+09 &
            + X* (  -.63070459710115776D+10 &
            + X* (   .65522247379405739D+11 &
            + X* (  -.41533064492642072D+12 &
            + X* (   .21996052328524087D+13 &
            + X* (  -.61090364473864102D+13 &
            + X* (   .12400345252146191D+14 &
                    ) ) )   ) ) )   ) ) )   ) ) )   ) ) )  * EX * .5Q0
      GO TO 1000

!    25.00  <=  Y = X**2  <=  45.00  (ERR =  .34E-14 )

    6 CONTINUE
      FV(16) = F16ASNT  &
            -    (   .46762657076544322Q-04 &
            + X* (   .97813605829114103D+00 &
            + X* (   .20231027186260583D+02 &
            + X* (  -.40322944676592033D+03 &
            + X* (   .60159551905614135D+05 &
            + X* (  -.37294415077286568D+07 &
            + X* (   .18619179780348065D+09 &
            + X* (  -.69518835295008793D+10 &
            + X* (   .19888245639831409D+12 &
            + X* (  -.43165589314506484D+13 &
            + X* (   .70080412789412977D+14 &
            + X* (  -.82480760146676950D+15 &
            + X* (   .66545162269826430D+16 &
            + X* (  -.32938502348586832D+17 &
            + X* (   .75478738662189792D+17 &
                    ) ) )   ) ) )   ) ) )   ) ) )   ) ) )  * EX * .5Q0
      GO TO 1000

!    45.00  <=  Y = X**2  <=  70.00  (ERR =  .79E-14 )

    7 CONTINUE
      FV(16) = F16ASNT  &
            -    (   .52503914255615225Q-03 &
            + X* (   .87908991062047614D+00 &
            + X* (   .26397372149708538D+02 &
            + X* (  -.24573173571110965D+03 &
            + X* (   .12125024785403497D+05 &
                    ) ) )   ) )   *  EX * .5Q0
      GO TO 1000

!    70.00  <   Y = X**2   (ERR =  .79E-14 )

    8 CONTINUE
      FV(16) = F16ASNT

 1000 CONTINUE

!     RECURSION FOR THE REMAINING FN(Y)  (N:0,... 15)

      DY = Y + Y
      FV(16) = FV(16) 
      FV(15) = (EX + DY * FV(16)) *  .32258064516129031Q-01
      FV(14) = (EX + DY * FV(15)) *  .34482758620689655Q-01
      FV(13) = (EX + DY * FV(14)) *  .37037037037037037Q-01
      FV(12) = (EX + DY * FV(13)) *  .40000000000000000Q-01
      FV(11) = (EX + DY * FV(12)) *  .43478260869565216Q-01
      FV(10) = (EX + DY * FV(11)) *  .47619047619047619Q-01
      FV( 9) = (EX + DY * FV(10)) *  .52631578947368418Q-01
      FV( 8) = (EX + DY * FV( 9)) *  .58823529411764705Q-01
      FV( 7) = (EX + DY * FV( 8)) *  .66666666666666667Q-01
      FV( 6) = (EX + DY * FV( 7)) *  .76923076923076923Q-01
      FV( 5) = (EX + DY * FV( 6)) *  .90909090909090909Q-01
      FV( 4) = (EX + DY * FV( 5)) *  .11111111111111111D+00
      FV( 3) = (EX + DY * FV( 4)) *  .14285714285714285D+00
      FV( 2) = (EX + DY * FV( 3)) *  .20000000000000000D+00
      FV( 1) = (EX + DY * FV( 2)) *  .33333333333333333D+00
      FV( 0) = (EX + DY * FV( 1)) 

      RETURN
      END

!*******************************************************************
!   FUNCION PARA CALCULAR LAS INTEGRALES BIELECTRONICAS
!*******************************************************************
	REAL*16 FUNCTION func(X,A,B,nC,nD,nF,G)
	REAL*16 X,G,A,B
	INTEGER*4 nC,nD,nF
	
!		func=(((1.0Q0-(B/A)*X)**nC)/(1.0Q0-X)**nD)*(x**(nF/2))*QEXP(-G*X)*QSQRT(X) 
		func=(((1.0-(B/A)*X*X)**nC)/(1.0Q0-X*X)**nD)*(x**(nF))*QEXP(-G*X*X) 

	END FUNCTION

    
!  (C) Copr. 1986-92 Numerical Recipes Software .

      SUBROUTINE polint(xa,ya,n,x,y,dy)
      INTEGER n,NMAX
      REAL*16 dy,x,y,xa(n),ya(n)
      PARAMETER (NMAX=10)
      INTEGER i,m,ns
      REAL*16 den,dif,dift,ho,hp,w,c(NMAX),d(NMAX)
      ns=1
      dif=QABS(x-xa(1))
      do 11 i=1,n
        dift=QABS(x-xa(i))
        if (dift.lt.dif) then
          ns=i
          dif=dift
        endif
        c(i)=ya(i)
        d(i)=ya(i)
11    continue
      y=ya(ns)
      ns=ns-1
      do 13 m=1,n-1
        do 12 i=1,n-m
          ho=xa(i)-x
          hp=xa(i+m)-x
          w=c(i+1)-d(i)
          den=ho-hp
          if(den.eq.0.)pause 'failure in polint'
          den=w/den
          d(i)=hp*den
          c(i)=ho*den
12      continue
        if (2*ns.lt.n-m)then
          dy=c(ns+1)
        else
          dy=d(ns)
          ns=ns-1
        endif
        y=y+dy
13    continue
      return
      END
!  (C) Copr. 1986-92 Numerical Recipes Software .

      SUBROUTINE qromb(a,b,ss,ax,bx,nC,nD,nF,G)
      INTEGER JMAX,JMAXP,K,KM
	INTEGER*4 nC,nD,nF
	REAL*16 ax,bx,G
      REAL*16 a,b,func,ss,EPS
      PARAMETER (EPS=1.e-10, JMAX=50, JMAXP=JMAX+1, K=5, KM=K-1)

!    USES polint,trapzd
      INTEGER j
      REAL*16 dss,h(JMAXP),s(JMAXP)
      h(1)=1.
      do 11 j=1,JMAX
        call trapzd(a,b,s(j),j,ax,bx,nC,nD,nF,G)
        if (j.ge.K) then
          call polint(h(j-KM),s(j-KM),K,0.Q0,ss,dss)
          if (abs(dss).le.EPS*abs(ss)) return
        endif
        s(j+1)=s(j)
        h(j+1)=0.25*h(j)
11    continue
      pause 'too many steps in qromb'
      END

!  (C) Copr. 1986-92 Numerical Recipes Software .

      SUBROUTINE trapzd(a,b,s,n,ax,bx,nC,nD,nF,G)
      INTEGER*4 n
      REAL*16 a,b,s,func
      INTEGER it,j
      REAL*16 del,sum,tnm,x,x2,Aux
	INTEGER*4 nC,nD,nF
	REAL*16 ax,bx,G
      if (n.eq.1) then
!        s=0.5*(b-a)*(func(a,ax,bx,nC,nD,nF,G)+func(b,ax,bx,nC,nD,nF,G))
	  s=0.5*(b-a)*(func(a,ax,bx,nC,nD,nF,G)+func(b,ax,bx,nC,nD,nF,G))
      else
        it=2**(n-2)
        tnm=it
        del=(b-a)/tnm
        x=a+0.5*del
        sum=0.

	  Aux=Bx/Ax
	  x2=X*X 

        do 11 j=1,it
!          sum=sum+func(x,ax,bx,nC,nD,nF,G)
		sum=sum+(((1.0-Aux*x2)**nC)/(1.0Q0-x2)**nD)*(x**(nF))*QEXP(-G*x2)
          x=x+del
	    x2=X*X 
11      continue
        s=0.5*(s+(b-a)*sum/tnm)
      endif
      return
      END
!  (C) Copr. 1986-92 Numerical Recipes Software .
